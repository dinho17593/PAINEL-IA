
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>zappbot</title>
    
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="theme-color" content="#121214">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="zappbot">
    
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="icon" type="image/png" href="icon-192x192.png">
    <link rel="shortcut icon" href="icon-192x192.png" type="image/x-icon">
    <link rel="manifest" href="/manifest.json">

    <script>
        (function() {
            try {
                const time = new Date().getTime();
                const icons = document.querySelectorAll('link[rel*="icon"]');
                icons.forEach(icon => {
                    if(icon.href) icon.href = icon.href.split('?')[0] + '?v=' + time;
                });
            } catch(e) {}
        })();
    </script>

    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

    :root {
        --bg-body: #09090b;
        --bg-card: #18181b; 
        --bg-input: #09090b;
        --bg-sidebar: rgba(24, 24, 27, 0.95); 
        
        --text-main: #f4f4f5;
        --text-muted: #a1a1aa;
        --border: rgba(255, 255, 255, 0.08); 
        
        --primary: #6366f1; 
        --primary-hover: #818cf8; 
        --primary-glow: rgba(99, 102, 241, 0.4);

        --purple-dark: #2e1065;   
        
        --green: #10b981;
        --red: #f43f5e;
        --blue: #3b82f6;
        --telegram-blue: #229ED9;
        --whatsapp-green: #25D366;
        --yellow: #f59e0b;
        --cyan: #06b6d4;
        
        --header-height: 60px;
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 24px;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-body); }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }

    body { 
        font-family: 'Plus Jakarta Sans', 'Inter', sans-serif; 
        background-color: var(--bg-body); 
        background-image: radial-gradient(circle at 50% 0%, rgba(99, 102, 241, 0.08) 0%, transparent 50%);
        color: var(--text-main); 
        margin: 0; 
        padding-bottom: 80px; 
        overflow-x: hidden; 
        line-height: 1.5;
        font-size: 0.9rem;
        -webkit-font-smoothing: antialiased;
    }
    
    #pwa-update-bar {
        display: none;
        position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
        background: rgba(24, 24, 27, 0.9); backdrop-filter: blur(12px);
        border: 1px solid var(--border); color: var(--text-main);
        padding: 10px 20px; border-radius: 50px; z-index: 9999;
        box-shadow: 0 20px 40px rgba(0,0,0,0.6); align-items: center; gap: 20px;
        font-weight: 500; width: auto; min-width: 300px; justify-content: space-between;
    }
    #pwa-update-bar.show { display: flex; animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
    #pwa-update-btn {
        background: var(--text-main); color: var(--bg-body); border: none; padding: 6px 14px;
        border-radius: 20px; font-weight: 700; cursor: pointer; font-size: 0.75rem; transition: transform 0.2s;
    }
    #pwa-update-btn:hover { transform: scale(1.05); }

    .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
    .hidden { display: none !important; }
    .text-truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .input-group { margin-bottom: 20px; position: relative; } 
    .input-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; color: var(--text-main); letter-spacing: 0.02em; }
    .help-text { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; display: block; line-height: 1.4; }
    .example-link { color: var(--primary); cursor: pointer; font-size: 0.75rem; text-decoration: none; font-weight: 600; transition: 0.2s; }
    .example-link:hover { color: var(--primary-hover); text-decoration: underline; }

    input, textarea, select { 
        width: 100%; padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); 
        border-radius: var(--radius-md); color: var(--text-main); font-size: 0.9rem; font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.3s ease;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--primary); background: rgba(255,255,255,0.05); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15); }
    input::placeholder { color: #52525b; }

    header { position: sticky; top: 0; z-index: 100; background: rgba(9, 9, 11, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); }
    .nav-bar { height: var(--header-height); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; position: relative; max-width: 1200px; margin: 0 auto; }
    .nav-btn { background: transparent; border: 1px solid transparent; color: var(--text-muted); font-size: 1.1rem; padding: 0; cursor: pointer; border-radius: 12px; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; text-decoration: none; }
    .nav-btn:hover { background: rgba(255,255,255,0.05); color: var(--text-main); border-color: var(--border); }
    .nav-btn:active { transform: scale(0.95); }
    
    #btn-help {
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.2);
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        background: transparent;
    }
    #btn-help i { font-size: 0.85rem; }
    #btn-help:hover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
        transform: rotate(15deg);
    }

    .brand-center { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 1.1rem; font-family: 'Outfit', sans-serif; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px; white-space: nowrap; letter-spacing: -0.03em; }
    .brand-center i { color: var(--primary); filter: drop-shadow(0 0 8px var(--primary-glow)); }
    
    .user-strip { background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border); padding: 8px 15px; text-align: center; font-size: 0.8rem; color: var(--text-muted); display: flex; justify-content: center; align-items: center; gap: 10px; backdrop-filter: blur(5px); }
    .limit-badge { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); padding: 2px 10px; border-radius: 20px; font-size: 0.7rem; color: var(--yellow); cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 600; transition: 0.2s; }
    .limit-badge:hover { background: rgba(245, 158, 11, 0.2); }

    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; backdrop-filter: blur(4px); transition: opacity 0.3s; }
    .sidebar { position: fixed; top: 0; left: -320px; width: 280px; height: 100%; background: var(--bg-sidebar); border-right: 1px solid var(--border); z-index: 1001; transition: cubic-bezier(0.4, 0, 0.2, 1) 0.4s; display: flex; flex-direction: column; box-shadow: 10px 0 30px rgba(0,0,0,0.5); backdrop-filter: blur(20px); }
    .sidebar.open { left: 0; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .sidebar-content { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 6px; }
    
    .sidebar-footer { padding: 15px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); }
    .sidebar-footer .sidebar-btn { color: var(--red); }
    .sidebar-footer .sidebar-btn:hover { background: rgba(244, 63, 94, 0.1); border-color: rgba(244, 63, 94, 0.2); }

    .sidebar-title { font-size: 1.1rem; font-family: 'Outfit', sans-serif; font-weight: 700; color: var(--text-main); }
    
    .sidebar-btn { background: transparent; border: 1px solid transparent; color: var(--text-muted); padding: 12px 16px; text-align: left; font-size: 0.9rem; font-weight: 500; cursor: pointer; border-radius: var(--radius-md); transition: all 0.2s; display: flex; align-items: center; gap: 12px; width: 100%; }
    .sidebar-btn:hover { background: rgba(255,255,255,0.04); color: var(--text-main); transform: translateX(5px); }
    .sidebar-btn.active { background: rgba(99, 102, 241, 0.1); color: var(--primary); border: 1px solid rgba(99, 102, 241, 0.2); font-weight: 600; }
    .sidebar-btn i { width: 18px; text-align: center; }

    button { cursor: pointer; font-family: 'Plus Jakarta Sans', sans-serif; border: none; }
    
    .btn-primary { background: var(--primary); background: linear-gradient(135deg, var(--primary) 0%, #4f46e5 100%); color: white; padding: 14px; border-radius: var(--radius-md); font-weight: 600; width: 100%; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3); transition: all 0.3s ease; position: relative; overflow: hidden; }
    .btn-primary:hover { box-shadow: 0 8px 25px rgba(79, 70, 229, 0.5); transform: translateY(-2px); }
    .btn-primary:active { transform: scale(0.98) translateY(0); }
    .btn-primary:disabled { background: #27272a; color: #52525b; cursor: not-allowed; box-shadow: none; transform: none; }

    .btn-google { background: white; color: #18181b; width: 100%; padding: 12px; border-radius: var(--radius-md); font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; transition: all 0.2s; border: 1px solid #e4e4e7; font-size: 0.9rem; }
    .btn-google:hover { background: #f4f4f5; transform: translateY(-1px); }
    .btn-google svg { width: 18px; height: 18px; }
    
    .auth-divider { position: relative; margin: 25px 0; text-align: center; }
    .auth-divider span { background: var(--bg-card); padding: 0 15px; color: var(--text-muted); font-size: 0.8rem; position: relative; z-index: 1; font-weight: 500; }
    .auth-divider::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: var(--border); z-index: 0; }

    .auth-wrapper { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: radial-gradient(circle at top, #1e1b4b 0%, #09090b 100%); }
    .auth-card { background: var(--bg-card); padding: 35px; border-radius: 24px; border: 1px solid var(--border); width: 100%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }

    #bots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }
    
    .bot-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 18px; overflow: hidden; display: flex; flex-direction: column; position: relative; transition: all 0.3s ease; }
    .bot-card:hover { transform: translateY(-4px); border-color: rgba(255,255,255,0.15); box-shadow: 0 15px 30px rgba(0,0,0,0.3); }

    .card-header { padding: 15px 20px; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    
    .status-badge { font-size: 0.65rem; padding: 4px 10px; border-radius: 30px; font-weight: 700; text-transform: uppercase; display: flex; align-items: center; gap: 5px; letter-spacing: 0.05em; }
    .st-online, .st-active { background: rgba(16, 185, 129, 0.1); color: var(--green); border: 1px solid rgba(16, 185, 129, 0.2); box-shadow: 0 0 10px rgba(16, 185, 129, 0.1); }
    .st-offline { background: rgba(113, 113, 122, 0.1); color: var(--text-muted); border: 1px solid rgba(113, 113, 122, 0.2); }
    .st-waiting { color: var(--blue); border: 1px solid rgba(59, 130, 246, 0.2); background: rgba(59, 130, 246, 0.1); }
    .st-expired { background: rgba(244, 63, 94, 0.1); color: var(--red); border: 1px solid rgba(244, 63, 94, 0.2); }
    .st-inactive, .st-pending { background: rgba(245, 158, 11, 0.1); color: var(--yellow); border: 1px solid rgba(245, 158, 11, 0.2); }
    .st-starting { background: rgba(99, 102, 241, 0.1); color: var(--primary); border: 1px solid rgba(99, 102, 241, 0.2); }

    .card-body { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; gap: 15px; }
    
    .progress-container { position: relative; margin-top: 5px; }
    .progress-info { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 6px; color: var(--text-muted); font-weight: 500; }
    .progress-bar-bg { height: 6px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: var(--primary); border-radius: 4px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 15px var(--primary-glow); }
    
    .date-info { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); padding: 3px 0; }
    .date-info strong { color: var(--text-main); font-weight: 600; }

    .logs-container { background: #000000; border-radius: var(--radius-sm); border: 1px solid #27272a; padding: 10px; font-family: 'JetBrains Mono', 'Courier New', monospace; font-size: 0.7rem; color: #4ade80; height: 120px; overflow-y: auto; display: flex; flex-direction: column; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5); }
    .log-line { padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); opacity: 0.9; }

    .qr-area { background: white; padding: 15px; border-radius: var(--radius-md); align-self: center; display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .qr-instructions { color: #18181b; margin-bottom: 12px; font-size: 0.8rem; text-align: left; width: 100%; }
    .qr-instructions ol { padding-left: 20px; margin: 5px 0; }
    .qr-instructions li { margin-bottom: 6px; line-height: 1.3; font-weight: 500; }
    
    .btn-share-qr { background: var(--primary); color: white; border: none; padding: 10px 12px; border-radius: var(--radius-sm); margin-top: 12px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; width: 100%; justify-content: center; font-weight: 600; transition: all 0.2s; }
    .btn-share-qr:hover { background: var(--primary-hover); transform: translateY(-1px); }

    .btn-use-code { background: transparent; color: var(--primary); border: 1px solid var(--primary); padding: 8px 12px; border-radius: var(--radius-sm); margin-top: 8px; cursor: pointer; font-size: 0.8rem; width: 100%; font-weight: 600; transition: 0.2s; }
    .btn-use-code:hover { background: rgba(99, 102, 241, 0.05); }

    .pairing-code-display { font-size: 1.8rem; font-weight: 800; color: #18181b; letter-spacing: 3px; margin: 15px 0; background: #f4f4f5; padding: 12px; border-radius: 10px; border: 2px dashed #d4d4d8; font-family: 'Courier New', monospace; }

    .action-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 3px;
        margin-top: 15px;
        gap: 2px;
        backdrop-filter: blur(5px);
    }

    .icon-btn {
        background: transparent;
        border: none;
        border-radius: 10px;
        padding: 8px 0;
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        transition: all 0.2s ease;
        position: relative;
        text-decoration: none;
        cursor: pointer;
    }

    .icon-btn:not(:last-child)::after {
        content: '';
        position: absolute;
        right: 0;
        top: 25%;
        height: 50%;
        width: 1px;
        background: rgba(255,255,255,0.05);
        transition: opacity 0.2s;
    }
    .icon-btn:hover::after { opacity: 0; }

    .icon-btn:hover {
        background: rgba(255, 255, 255, 0.04);
        color: var(--text-main);
        transform: translateY(0);
    }
    .icon-btn:active { transform: scale(0.96); }

    .icon-btn i {
        font-size: 1rem;
        margin-bottom: 3px;
        transition: color 0.2s;
    }

    .icon-btn span {
        font-size: 0.6rem;
        font-weight: 600;
        letter-spacing: 0.03em;
        opacity: 0.8;
        text-transform: uppercase;
    }
    
    .btn-act-start:hover i { color: var(--green); }
    .btn-act-start:hover { background: rgba(16, 185, 129, 0.05); }
    
    .btn-act-stop:hover i { color: var(--red); }
    .btn-act-stop:hover { background: rgba(244, 63, 94, 0.05); }
    
    .btn-act-pay:hover i { color: var(--cyan); }
    .btn-act-pay:hover { background: rgba(6, 182, 212, 0.05); }

    .btn-act-link:hover i { color: var(--blue); }
    .btn-act-link:hover { background: rgba(59, 130, 246, 0.05); }

    .btn-act-groups:hover i { color: var(--yellow); }
    .btn-act-groups:hover { background: rgba(245, 158, 11, 0.05); }

    .badge-count {
        background: rgba(255,255,255,0.1);
        padding: 1px 5px;
        border-radius: 8px;
        font-size: 0.55rem;
        margin-left: 3px;
        vertical-align: middle;
    }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
    .modal-content { background: #18181b; padding: 25px; border-radius: 20px; width: 90%; max-width: 450px; border: 1px solid var(--border); animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1); max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
    @keyframes slideUpFade { from { transform: translateY(40px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    
    /* Chat Modal Specifics - FULL SCREEN */
    .modal-content-chat {
        width: 100%;
        height: 100%;
        max-width: none;
        max-height: none;
        border-radius: 0;
        display: flex;
        flex-direction: column;
        padding: 0;
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
        margin: 0;
    }

    .chat-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255,255,255,0.02);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .chat-bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 0.9rem;
        line-height: 1.5;
        position: relative;
        word-wrap: break-word;
    }

    .chat-bubble.bot {
        background: rgba(255,255,255,0.05);
        color: var(--text-main);
        border-bottom-left-radius: 4px;
        align-self: flex-start;
        border: 1px solid var(--border);
    }

    .chat-bubble.user {
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 4px;
        align-self: flex-end;
        box-shadow: 0 4px 15px var(--primary-glow);
    }

    /* Typing Indicator Styles */
    .typing-indicator {
        background: rgba(255,255,255,0.05);
        padding: 15px;
        border-radius: 18px;
        border-bottom-left-radius: 4px;
        display: table;
        align-self: flex-start;
        border: 1px solid var(--border);
        margin-bottom: 15px;
    }
    .typing-dots {
        display: flex;
        gap: 4px;
    }
    .typing-dot {
        width: 6px;
        height: 6px;
        background: var(--text-muted);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out both;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    .chat-input-area {
        padding: 15px;
        border-top: 1px solid var(--border);
        background: rgba(255,255,255,0.02);
        display: flex;
        gap: 10px;
    }

    .chat-input {
        flex: 1;
        background: rgba(255,255,255,0.05);
        border: 1px solid var(--border);
        border-radius: 25px;
        padding: 12px 20px;
        color: var(--text-main);
        font-size: 0.9rem;
    }
    .chat-input:focus { border-color: var(--primary); }

    .chat-send-btn {
        background: var(--primary);
        color: white;
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .chat-send-btn:hover { transform: scale(1.1); }

    .action-chip {
        display: inline-block;
        margin-top: 8px;
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .action-chip:hover {
        background: rgba(99, 102, 241, 0.1);
        transform: translateY(-1px);
    }

    .form-section { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
    
    .plan-option { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s; }
    .plan-option:hover { background: rgba(255,255,255,0.06); border-color: var(--primary); transform: scale(1.01); }
    .plan-title { font-weight: 700; font-size: 1rem; color: var(--text-main); }
    .plan-desc { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
    .plan-price { font-weight: 800; color: var(--green); font-size: 1.1rem; }
    .plan-badge-resell { background: var(--purple-dark); color: #e9d5ff; font-size: 0.65rem; padding: 3px 6px; border-radius: 6px; margin-left: 6px; font-weight: 600; }

    #feedback-area { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 10000; padding: 12px 25px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; width: auto; min-width: 300px; text-align: center; backdrop-filter: blur(10px); }
    .feedback-success { background: rgba(16, 185, 129, 0.9); color: white; }
    .feedback-error { background: rgba(244, 63, 94, 0.9); color: white; }

    .section-divider-title { font-size: 0.8rem; color: var(--primary); margin: 20px 0 12px 0; border-bottom: 1px solid rgba(99, 102, 241, 0.2); padding-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; }
    
    .admin-tools { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #3f3f46; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .admin-tools span { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; }
    
    .counter-wrapper { display: flex; align-items: center; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    .counter-btn { background: rgba(255,255,255,0.05); border: none; color: var(--text-main); padding: 8px 12px; cursor: pointer; transition: 0.2s; }
    .counter-btn:hover { background: rgba(255,255,255,0.1); }
    .days-input { width: 50px !important; text-align: center; border: none !important; margin: 0 !important; padding: 4px !important; background: transparent !important; font-weight: bold; font-size: 0.9rem; }
    
    .btn-save-days { background: var(--primary); color: white; border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.2s; }
    .btn-save-days:hover { transform: scale(1.1); }

    .list-container { max-height: 200px; overflow-y: auto; background: var(--bg-input); border-radius: 12px; border: 1px solid var(--border); padding: 12px; margin-bottom: 15px; }
    .ignored-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 6px; font-weight: 500; border: 1px solid transparent; }
    .ignored-item:hover { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); }
    .ignored-item .fas.fa-times { color: var(--text-muted); cursor: pointer; padding: 6px; transition: 0.2s; }
    .ignored-item .fas.fa-times:hover { color: var(--red); transform: scale(1.2); }

    .payment-success-container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; text-align: center; padding: 20px 0; }

    .qr-wrapper { background: #fff; padding: 15px; border-radius: 16px; margin: 15px auto; display: flex; justify-content: center; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: fit-content; border: 4px solid white; }

    .amount-display { font-size: 2.2rem; color: var(--text-main); font-weight: 800; margin: 10px 0; letter-spacing: -1px; text-shadow: 0 0 20px rgba(255,255,255,0.1); }

    .copy-row { display: flex; gap: 10px; margin-top: 15px; width: 100%; justify-content: center; }

    .input-copy { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text-muted); padding: 10px; border-radius: 10px; font-size: 0.8rem; text-align: center; width: 100%; margin: 0 !important; font-family: 'Courier New', monospace; }

    .btn-copy { background: var(--primary); color: white; border: none; border-radius: 10px; padding: 0 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .btn-copy:hover { filter: brightness(1.1); }

    .btn-share-pix { background: #fff; color: #000; border: none; width: 100%; padding: 12px; border-radius: 10px; margin-top: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s; }
    .btn-share-pix:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,255,255,0.2); }

    .btn-support { 
        position: fixed; bottom: 25px; right: 25px; width: 56px; height: 56px; 
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: #fff; 
        border-radius: 50%; display: none; align-items: center; justify-content: center; 
        font-size: 2rem; box-shadow: 0 10px 25px rgba(37, 211, 102, 0.4); z-index: 1500; 
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-decoration: none; 
    }
    .btn-support:hover { transform: scale(1.1) rotate(10deg); }
    .btn-support:active { transform: scale(0.9); }
    
    .checkbox-group { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.03); padding: 14px; border-radius: 12px; border: 1px solid var(--border); margin-top: 15px; transition: 0.2s; }
    .checkbox-group:hover { border-color: var(--primary); background: rgba(255,255,255,0.05); }
    .checkbox-group input { width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; }
    .checkbox-group label { margin: 0; font-weight: 600; font-size: 0.9rem; cursor: pointer; }
    
    .bot-tag { font-size: 0.65rem; font-weight: 700; background: var(--purple-dark); color: #e9d5ff; padding: 3px 8px; border-radius: 20px; margin-left: 8px; letter-spacing: 0.03em; }
    .platform-icon-wa { color: var(--whatsapp-green); filter: drop-shadow(0 0 5px rgba(37, 211, 102, 0.3)); }
    .platform-icon-tg { color: var(--telegram-blue); filter: drop-shadow(0 0 5px rgba(34, 158, 217, 0.3)); }

    .bot-groups-container { 
        display: none; 
        margin-top: 10px;
        padding: 5px;
        border-top: 1px solid var(--border);
    }
    .bot-groups-container.show { 
        display: block; 
        animation: slideDown 0.3s ease; 
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .nested-group-card { background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; }
    .nested-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .nested-group-title { font-weight: 700; font-size: 1rem; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
    
    .empty-state { text-align: center; padding: 50px 20px; color: var(--text-muted); border: 2px dashed var(--border); border-radius: 24px; margin-top: 25px; background: rgba(255,255,255,0.01); }
    .empty-state i { font-size: 3rem; margin-bottom: 15px; color: var(--primary); opacity: 0.4; }
    .empty-state h3 { color: var(--text-main); margin: 0 0 10px 0; font-size: 1.1rem; }
    .empty-state p { font-size: 0.9rem; margin: 0; max-width: 400px; margin: 0 auto; }

    .type-select-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .type-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 16px; padding: 20px 15px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .type-card:hover { background: rgba(255,255,255,0.06); border-color: var(--primary); transform: translateY(-3px); }
    .type-card i { font-size: 1.8rem; color: var(--primary); margin-bottom: 5px; }
    .type-card h4 { margin: 0; font-size: 0.95rem; color: var(--text-main); }
    .type-card p { margin: 0; font-size: 0.75rem; color: var(--text-muted); }
    
    .icon-preview-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        background: rgba(255,255,255,0.03);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid var(--border);
    }
    .icon-preview-img {
        width: 70px;
        height: 70px;
        object-fit: contain;
        border-radius: 12px;
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--border);
        padding: 5px;
    }

    /* Onboarding Guide Styles - FIXED */
    @keyframes pulse-guide {
        0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); transform: scale(1); }
        70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); transform: scale(1.02); }
        100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); transform: scale(1); }
    }

    .guide-highlight {
        animation: pulse-guide 2s infinite;
        position: relative !important; /* Forces positioning context */
        z-index: 100 !important;       /* Brings element to top */
        border-color: var(--primary) !important;
        overflow: visible !important;  /* CRITICAL: Allows icon to spill out of buttons */
    }

    .guide-highlight::after {
        content: '\f0a7'; /* HAND POINT DOWN */
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        position: absolute;
        top: -45px; /* Moved higher up */
        left: 50%;
        transform: translateX(-50%);
        color: var(--primary);
        font-size: 2rem; /* Larger icon */
        animation: bounce-guide 1s infinite alternate;
        text-shadow: 0 2px 5px rgba(0,0,0,0.8);
        pointer-events: none;
        z-index: 101; /* Sits above the highlighted element */
    }

    @keyframes bounce-guide {
        from { top: -45px; }
        to { top: -55px; }
    }
</style>
</head>
<body>

    <div id="pwa-update-bar">
        <span>Nova versão disponível!</span>
        <button id="pwa-update-btn">ATUALIZAR AGORA</button>
    </div>

    <div id="feedback-area"></div>

    <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title"><i class="fas fa-bars"></i> Menu</span>
            <i class="fas fa-times" onclick="toggleSidebar()" style="cursor:pointer; padding:5px;"></i>
        </div>
        <div class="sidebar-content">
            <button class="sidebar-btn active" id="btn-nav-dashboard" onclick="navToDashboard()">
                <i class="fas fa-home"></i> Início
            </button>
            <button class="sidebar-btn" id="btn-nav-admin" onclick="navToAdminSettings()">
                <i class="fas fa-cog"></i> Configurações & Backup
            </button>
            <button class="sidebar-btn" onclick="window.location.href='/clients.html'">
                <i class="fas fa-users-cog"></i> Gerenciador de Clientes
            </button>
        </div>
        <div class="sidebar-footer">
            <button class="sidebar-btn logout-btn" onclick="confirmLogout()">
                <i class="fas fa-sign-out-alt"></i> Sair do Painel
            </button>
        </div>
    </div>

    <!-- Initial Loader -->
    <div id="app-loader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 99999; display: flex; justify-content: center; align-items: center;">
        <i class="fas fa-circle-notch fa-spin fa-3x" style="color: var(--primary);"></i>
    </div>

    <div id="auth-section" class="auth-wrapper" style="display: none;">
        <div class="auth-card">
            <div style="text-align: center; margin-bottom: 25px;">
                <h1 style="color: var(--primary); margin: 0; font-size: 1.8rem;"><i class="fas fa-robot"></i></h1>
                <h2 style="margin: 5px 0 0 0; font-size: 1.4rem;">zappbot</h2>
                <p style="color: var(--text-muted); font-size: 0.85rem;">Automação Simplificada</p>
            </div>
            
            <div id="login-form-container">
                <form id="login-form">
                    <div class="input-group" style="margin-bottom:15px;"><label class="input-label">Seu Email ou Usuário</label><input type="text" id="login-username" required></div>
                    <div class="input-group" style="margin-bottom:20px;"><label class="input-label">Sua Senha</label><input type="password" id="login-password" required></div>
                    <button type="submit" id="btn-login-submit" class="btn-primary">Entrar no Painel</button>
                </form>
                <div class="auth-divider"><span>ou continue com</span></div>
                <a href="/auth/google" class="btn-google"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg> Google</a>
                <p class="text-center" style="margin-top: 20px; font-size: 0.85rem;">
                    Não tem conta? <a href="javascript:void(0)" style="color: var(--primary); text-decoration: none; font-weight: 600;" onclick="toggleAuthForms()">Criar conta</a>
                </p>
            </div>

            <div id="register-form-container" class="hidden">
                <form id="register-form">
                    <div class="input-group" style="margin-bottom:15px;">
                        <label class="input-label">Escolha um Usuário</label>
                        <input type="text" id="reg-username" required>
                    </div>
                    <div class="input-group" style="margin-bottom:20px;">
                        <label class="input-label">Escolha uma Senha</label>
                        <input type="password" id="reg-password" required>
                    </div>
                    <button type="submit" id="btn-register-submit" class="btn-primary">Criar Conta</button>
                </form>
                <div class="auth-divider"><span>ou cadastre-se com</span></div>
                <a href="/auth/google" class="btn-google"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg> Google</a>
                <p class="text-center" style="margin-top: 20px; font-size: 0.85rem;">
                    Já tem conta? <a href="javascript:void(0)" style="color: var(--primary); text-decoration: none; font-weight: 600;" onclick="toggleAuthForms()">Fazer Login</a>
                </p>
            </div>
        </div>
    </div>

    <div id="dashboard-container" class="hidden">
        <header>
            <div class="nav-bar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="nav-back-btn" class="nav-btn hidden" onclick="goBackToAdminHome()"><i class="fas fa-chevron-left"></i></button>
                    <button id="admin-menu-btn" class="nav-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                </div>
                
                <div class="brand-center"><i class="fas fa-robot"></i> zappbot</div>
                <button id="btn-help" class="nav-btn" title="Ajuda" onclick="openSupportChat()"><i class="fas fa-question"></i></button>
            </div>
            <div class="user-strip">
                <i class="fas fa-user-circle"></i> Olá, <strong id="user-display-name" class="text-truncate">...</strong>
                <div id="user-limit-badge" class="limit-badge" onclick="openResellModal()" title="Clique para aumentar seu limite">Limite: <span id="current-limit-display">1</span> <i class="fas fa-plus-circle" style="font-size:0.6rem;"></i></div>
            </div>
        </header>
        <div class="container">
            
            <div id="user-view">
                <div id="view-header" style="margin: 15px 0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 id="main-title-text" style="font-size: 1.1rem; margin: 0;">Meus Robôs</h2>
                        <p id="sub-title-text" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px;">Aqui você cria e controla seus atendentes virtuais.</p>
                    </div>
                    <button id="btn-new-bot" class="btn-primary" onclick="openCreateModal()" style="width: auto; padding: 10px 18px; font-size: 0.85rem;">
                        <i class="fas fa-plus"></i> Novo Robô
                    </button>
                </div>
                
                <div id="bots-grid"></div>

                <div id="user-logs-area" class="hidden" style="margin-top: 30px;">
                    <h4>Histórico de Atividades</h4>
                    <div id="user-log-content" class="logs-container" style="height: 150px; color: #ccc;"></div>
                </div>
            </div>

            <div id="admin-settings-view" class="hidden">
                <div id="view-header-admin" style="margin: 15px 0;">
                    <h2 style="font-size: 1.1rem; margin: 0;">Configurações & Backup</h2>
                    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px;">Gerencie seus dados e configurações.</p>
                </div>

                <div class="form-section" style="border-color: var(--yellow);">
                    <h4 style="color: var(--yellow); margin-top: 0; margin-bottom: 12px;"><i class="fas fa-database"></i> Backup e Restauração</h4>
                    <p class="help-text">Baixe um backup completo dos dados (Usuários, Bots, Grupos e Configurações) para segurança. As sessões do WhatsApp (QR Codes) não são incluídas para manter o arquivo leve.</p>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button onclick="downloadBackup()" class="btn-primary" style="background: var(--bg-input); border: 1px solid var(--yellow); color: var(--yellow); flex: 1;">
                            <i class="fas fa-download"></i> Baixar Backup (JSON)
                        </button>
                        
                        <div style="flex: 1; display: flex; gap: 10px;">
                            <input type="file" id="restore-file-input" accept=".zip" style="display: none;" onchange="handleRestoreFile()">
                            <button onclick="document.getElementById('restore-file-input').click()" class="btn-primary" style="background: var(--yellow); color: #000;">
                                <i class="fas fa-upload"></i> Restaurar Backup
                            </button>
                        </div>
                    </div>
                </div>

                <div id="admin-only-content" class="hidden">
                    <div class="form-section" style="border-color: var(--purple-dark);">
                        <h4 style="color: #e9d5ff; margin-top: 0; margin-bottom: 12px;"><i class="fas fa-images"></i> Logos do Sistema</h4>
                        <p class="help-text">Atualize os ícones do sistema. As imagens serão renomeadas automaticamente.</p>
                        
                        <form id="upload-icons-form" style="display: flex; flex-direction: column; gap: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="icon-preview-container">
                                    <label class="input-label">Ícone Pequeno (192x192)</label>
                                    <img id="preview-icon-small" src="/icon-192x192.png" class="icon-preview-img">
                                    <input type="file" id="input-icon-small" name="iconSmall" accept="image/png" required>
                                </div>
                                <div class="icon-preview-container">
                                    <label class="input-label">Ícone Grande (512x512)</label>
                                    <img id="preview-icon-large" src="/icon-512x512.png" class="icon-preview-img">
                                    <input type="file" id="input-icon-large" name="iconLarge" accept="image/png" required>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary" style="background: var(--purple-dark); color: #fff;">
                                <i class="fas fa-upload"></i> Atualizar Ícones
                            </button>
                        </form>
                    </div>

                    <div class="form-section" style="border-color: var(--cyan);">
                        <h4 style="color: var(--cyan); margin-top: 0; margin-bottom: 12px;"><i class="fas fa-cog"></i> Preços e Configurações</h4>
                        <form id="admin-settings-form">
                            <div class="input-group">
                                <label class="input-label">Nome da Aplicação</label>
                                <input type="text" id="admin-app-name" placeholder="zappbot">
                            </div>

                            <div class="input-group"><label class="input-label">Token MercadoPago (Produção)</label><input type="text" id="mp-access-token" placeholder="APP_USR-xxxxxxxx..." required></div>
                            
                            <div class="input-group">
                                <label class="input-label">Número de Suporte (WhatsApp) (Opcional)</label>
                                <span class="help-text">Número que aparecerá no botão flutuante de suporte (com DDD).</span>
                                <input type="number" id="admin-support-number" placeholder="5511956087683">
                            </div>

                            <div class="section-divider-title">Preços Renovação (Individual & Grupos)</div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                                <div><label style="font-size:0.7rem; color:#888;">Mensal (R$)</label><input type="number" id="price-monthly" step="0.01"></div>
                                <div><label style="font-size:0.7rem; color:#888;">Trimestral (R$)</label><input type="number" id="price-quarterly" step="0.01"></div>
                                <div><label style="font-size:0.7rem; color:#888;">Semestral (R$)</label><input type="number" id="price-semiannual" step="0.01"></div>
                                <div><label style="font-size:0.7rem; color:#888;">Anual (R$)</label><input type="number" id="price-yearly" step="0.01"></div>
                            </div>
                            <div class="section-divider-title">Planos Revenda (Aumento de Limite)</div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                                <div><label style="font-size:0.7rem; color:#888;">Lote 5 Bots</label><input type="number" id="price-resell-5" step="0.01"></div>
                                <div><label style="font-size:0.7rem; color:#888;">Lote 10 Bots</label><input type="number" id="price-resell-10" step="0.01"></div>
                                <div><label style="font-size:0.7rem; color:#888;">Lote 20 Bots</label><input type="number" id="price-resell-20" step="0.01"></div>
                                <div><label style="font-size:0.7rem; color:#888;">Lote 30 Bots</label><input type="number" id="price-resell-30" step="0.01"></div>
                            </div>
                            <button type="submit" class="btn-primary" style="background: var(--cyan); color: #000; margin-top: 10px;">Salvar Alterações</button>
                        </form>
                    </div>

                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0;">Gerenciar Usuários</h4>
                        </div>
                        <ul id="users-list" style="list-style: none; padding: 0;"></ul>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="create-bot-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 style="margin:0;"><i class="fas fa-plus-circle" style="color: var(--primary);"></i> Criar Novo Robô</h3>
                <i class="fas fa-times" onclick="closeCreateModal()" style="padding:10px; cursor:pointer;"></i>
            </div>

            <div id="create-step-1">
                <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center;">Qual será a função deste robô?</p>
                <div class="type-select-grid">
                    <div class="type-card" onclick="selectBotType('individual')">
                        <i class="fas fa-user-shield"></i>
                        <h4>Atendimento Privado</h4>
                        <p>Responde clientes no PV (1 a 1).</p>
                    </div>
                    <div class="type-card" onclick="selectBotType('group')">
                        <i class="fas fa-users"></i>
                        <h4>Gestão de Grupos</h4>
                        <p>Administra e responde em grupos.</p>
                    </div>
                </div>
            </div>

            <div id="create-step-2" class="hidden">
                <form id="add-bot-form">
                    <input type="hidden" id="selectedBotType" value="individual">
                    
                    <div class="input-group">
                        <label for="botPlatform" class="input-label">Plataforma</label>
                        <select id="botPlatform" onchange="togglePlatformFields()">
                            <option value="whatsapp">WhatsApp</option>
                            <option value="telegram">Telegram</option>
                        </select>
                    </div>

                    <div id="telegram-token-group" class="input-group hidden" style="display: none;">
                        <label for="telegramToken" class="input-label">Token do Bot (Telegram)</label>
                        <span class="help-text">Cole o token fornecido pelo @BotFather.</span>
                        <input type="text" id="telegramToken" placeholder="Ex: 123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11">
                    </div>

                    <div class="input-group" id="sessionName-group">
                        <label for="sessionName" class="input-label">1. Nome de Identificação</label>
                        <span class="help-text">Um nome curto para você identificar este bot (ex: Loja_Centro). Sem espaços.</span>
                        <input type="text" id="sessionName" placeholder="Ex: Bot_Vendas_01">
                    </div>
                    
                    <div id="prompt-container" class="input-group">
                        <label for="prompt" class="input-label">2. Personalidade do Robô <span class="example-link" onclick="fillExamplePrompt()">Ver Exemplo</span></label>
                        <span class="help-text">Explique como ele deve agir. Diga quem ele é, o que vende e como deve responder.</span>
                        <textarea id="prompt" rows="6" required placeholder="Ex: Você é um assistente virtual da Loja X..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn-primary" onclick="backToBotTypeSelect()" style="background: transparent; border: 1px solid var(--border); color: var(--text-muted); width: auto;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <button type="submit" class="btn-primary" id="create-bot-btn" style="flex: 1;">Salvar e Criar Robô</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>Editar Robô</h3><i class="fas fa-times" onclick="closeEditModal()" style="padding:10px; cursor:pointer;"></i></div>
            <form id="edit-bot-form">
                <input type="hidden" id="edit-sessionName-hidden">
                <label class="input-label">Nome de Identificação</label>
                <input type="text" id="edit-sessionName-display" disabled style="opacity: 0.5; margin-bottom:15px; width:100%; padding:10px; border:1px solid #333; background:#111; color:#777; border-radius:6px;">
                
                <div id="edit-global-settings">
                    <label class="input-label">Personalidade</label>
                    <textarea id="edit-prompt" rows="8" required style="font-family: sans-serif;"></textarea>
                    
                    <div id="edit-silence-wrapper" style="margin-top: 15px;">
                        <label class="input-label">Silêncio (min) (Opcional)</label>
                        <input type="number" id="edit-silenceTime" placeholder="0" min="0">
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label class="input-label">Número de Notificação (Opcional)</label>
                        <span class="help-text">Receba um aviso no seu WhatsApp pessoal quando o bot responder. (Ex: 5511999999999)</span>
                        <input type="number" id="edit-notificationNumber" placeholder="5511999999999">
                    </div>
                </div>
                
                <div id="edit-group-mode-msg" class="hidden" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; color: var(--text-muted); font-size: 0.85rem;">
                    <i class="fas fa-info-circle"></i> Este bot está em Modo Grupo. As configurações de Personalidade, Nome e Silêncio devem ser feitas individualmente em cada grupo.
                </div>

                <div class="checkbox-group" id="edit-type-wrapper">
                    <input type="checkbox" id="edit-botTypeGroup">
                    <div>
                        <label for="edit-botTypeGroup">Ativar Modo Grupo</label>
                        <div class="help-text">Este bot atuará em múltiplos grupos.</div>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="margin-top:10px;">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <div id="group-edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>Configurar Grupo</h3><i class="fas fa-times" onclick="document.getElementById('group-edit-modal').style.display='none'" style="padding:10px; cursor:pointer;"></i></div>
            <form id="edit-group-form">
                <input type="hidden" id="edit-group-id-hidden">
                <p style="margin-bottom: 15px; color: var(--text-muted); font-size: 0.85rem;">Grupo: <strong id="edit-group-name-display" style="color: var(--text-main);"></strong></p>
                
                <label class="input-label">Personalidade (Prompt)</label>
                <span class="help-text">Como o bot deve se comportar neste grupo específico.</span>
                <textarea id="edit-group-prompt" rows="6" style="font-family: sans-serif;" placeholder="Ex: Você é o admin deste grupo..."></textarea>
                
                <div style="margin-top: 15px;">
                    <label class="input-label">Nome do Bot (Gatilho)</label>
                    <span class="help-text">Nome para chamar o bot neste grupo.</span>
                    <input type="text" id="edit-group-botname" placeholder="Ex: Jarvis">
                </div>

                <div style="margin-top: 15px;">
                    <label class="input-label">Tempo de Silêncio (min) (Opcional)</label>
                    <span class="help-text">Intervalo entre respostas automáticas neste grupo.</span>
                    <input type="number" id="edit-group-silence" placeholder="0" min="0">
                </div>

                <button type="submit" class="btn-primary" style="margin-top:20px;">Salvar Configurações</button>
            </form>
        </div>
    </div>

    <div id="ignore-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin-top:0;">Ignorar por Nome</h3>
                <i class="fas fa-times" onclick="document.getElementById('ignore-modal').style.display='none'" style="padding:10px; cursor:pointer;"></i>
            </div>
            <p class="help-text" style="margin-top:-10px; margin-bottom:15px;">O robô não responderá aos contatos com nome exato na lista. O bot será reiniciado a cada alteração.</p>
            
            <input type="hidden" id="ignore-sessionName-hidden">
            
            <form id="add-identifier-form">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="new-identifier-input" required placeholder="Digite o nome completo do contato">
                    <button type="submit" class="btn-primary" style="width:auto; padding:0 20px;">Adicionar</button>
                </div>
            </form>

            <div class="section-divider-title" style="margin-top: 30px;">Atualmente Ignorados</div>
            <div id="ignored-list-container" class="list-container">
            </div>
        </div>
    </div>

    <div id="pairing-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin-top:0;">Conectar com Número</h3>
                <i class="fas fa-times" onclick="document.getElementById('pairing-modal').style.display='none'" style="padding:10px; cursor:pointer;"></i>
            </div>
            <p class="help-text" style="margin-top:-10px; margin-bottom:15px;">Digite o número do WhatsApp que será o robô (com DDD). Ex: 5511999999999</p>
            
            <input type="hidden" id="pairing-sessionName-hidden">
            
            <form id="pairing-form">
                <div class="input-group">
                    <input type="number" id="pairing-phone-number" required placeholder="5511999999999" style="text-align:center; font-size:1.2rem; letter-spacing:1px;">
                </div>
                <button type="submit" class="btn-primary">Gerar Código</button>
            </form>
        </div>
    </div>

    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <i class="fas fa-times" onclick="closePaymentModal()" style="position:absolute; right:20px; top:20px; padding:10px; cursor:pointer;"></i>
            <h3 style="color: var(--cyan);">Renovar Acesso</h3>
            <p style="font-size: 0.85rem; color: #aaa; margin-bottom: 20px;">
                <span id="payment-target-label">Robô</span>: <strong id="pay-session-name" style="color: white;"></strong>
            </p>
            
            <div id="pay-step-select">
                <p style="color:#e1e1e6; margin-bottom:15px; font-weight:600;">Por quanto tempo deseja renovar?</p>
                <div id="plans-container"></div>
            </div>

            <div id="pix-loading" class="hidden payment-success-container" style="padding: 40px 0;">
                <i class="fas fa-circle-notch fa-spin fa-2x" style="color: var(--cyan);"></i>
                <p style="margin-top: 15px;">Gerando código Pix...</p>
            </div>

            <div id="pix-content" class="hidden payment-success-container">
                <h2 id="pay-amount" class="amount-display">R$ --</h2>
                
                <div class="qr-wrapper">
                    <img id="pix-qrcode-display" src="" style="width: 180px; display: block;">
                </div>

                <div class="copy-row">
                    <input type="text" id="pix-copy-paste" readonly class="input-copy">
                    <button onclick="copyPixCode('pix-copy-paste')" class="btn-copy" style="background: var(--cyan);">Copiar</button>
                </div>

                <button onclick="sharePixPayment('individual')" class="btn-share-pix">
                    <i class="fas fa-share-alt"></i> Compartilhar Pagamento
                </button>

                <p style="color: var(--green); font-size: 0.75rem; margin-top: 15px;"><i class="fas fa-check-circle"></i> Liberação Automática após pagamento</p>
                <button onclick="resetPaymentModal()" style="background:transparent; color:#888; border:1px solid #333; padding:8px 20px; border-radius:20px; margin-top:10px; font-size:0.75rem;">Voltar</button>
            </div>
        </div>
    </div>

    <div id="resell-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <i class="fas fa-times" onclick="document.getElementById('resell-modal').style.display='none'" style="position:absolute; right:20px; top:20px; padding:10px; cursor:pointer;"></i>
            <h3 style="color: var(--primary);">Aumente seu Limite!</h3>
            <p style="font-size: 0.85rem; color: #aaa; margin-bottom: 20px;">Limite atual: <strong><span id="current-limit-display-modal">1</span></strong> robô(s).</p>
            
            <div id="resell-step-select">
                <div id="resell-plans-container"></div>
            </div>
            
            <div id="resell-pix-loading" class="hidden payment-success-container" style="padding: 40px 0;">
                <i class="fas fa-circle-notch fa-spin fa-2x" style="color: var(--primary);"></i>
                <p style="margin-top: 10px;">Gerando Pix...</p>
            </div>

            <div id="resell-pix-content" class="hidden payment-success-container">
                <h2 id="resell-pay-amount" class="amount-display">R$ --</h2>
                
                <div class="qr-wrapper">
                    <img id="resell-qrcode-display" src="" style="width: 180px; display: block;">
                </div>

                <div class="copy-row">
                    <input type="text" id="resell-copy-paste" readonly class="input-copy">
                    <button onclick="copyPixCode('resell-copy-paste')" class="btn-copy">Copiar</button>
                </div>

                <button onclick="sharePixPayment('resell')" class="btn-share-pix">
                    <i class="fas fa-share-alt"></i> Compartilhar Pagamento
                </button>

                <p style="color: var(--green); font-size: 0.75rem; margin-top: 15px;">Limite atualizado automaticamente!</p>
            </div>
        </div>
    </div>

    <div id="activation-link-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color: var(--blue);">Link de Ativação de Grupo</h3>
                <i class="fas fa-times" onclick="document.getElementById('activation-link-modal').style.display='none'" style="padding:10px; cursor:pointer;"></i>
            </div>
            <p class="help-text" style="margin-bottom: 20px;">Siga os passos abaixo para ativar seu grupo:</p>
            <ol style="font-size: 0.85rem; line-height: 1.6; padding-left: 20px; color: var(--text-muted);">
                <li style="margin-bottom: 8px;">Adicione o bot ('<strong id="modal-bot-name"></strong>') ao grupo.</li>
                <li style="margin-bottom: 8px;">Clique no botão abaixo para copiar o link de ativação único.</li>
                <li style="margin-bottom: 8px;">Cole e envie este link como uma mensagem dentro do grupo que você deseja ativar.</li>
                <li style="margin-bottom: 8px; color: var(--green); font-weight: bold;">Após ativar, o grupo aparecerá dentro do card deste robô.</li>
            </ol>
            <div class="input-group" style="margin-top: 25px;">
                <label class="input-label">Seu Link Único (expira em 15 min)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="activation-link-input" readonly style="background: var(--bg-input); opacity: 0.7;">
                    <button id="copy-activation-link-btn" class="btn-primary" style="width: auto; padding: 0 20px; background: var(--blue);">Copiar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Chat Modal -->
    <div id="support-chat-modal" class="modal-overlay">
        <div class="modal-content modal-content-chat">
            <div class="chat-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-robot" style="color: var(--primary); font-size: 1.2rem;"></i>
                    <div>
                        <h3 style="margin:0; font-size:1rem;">Suporte Inteligente</h3>
                        <span style="font-size:0.7rem; color:var(--green);">● Online</span>
                    </div>
                </div>
                <i class="fas fa-times" onclick="closeSupportChat()" style="padding:10px; cursor:pointer; font-size:1.1rem;"></i>
            </div>
            
            <div id="chat-messages" class="chat-messages">
                <!-- Messages will be loaded here -->
            </div>

            <div class="chat-input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="Digite sua dúvida..." onkeypress="handleChatKey(event)">
                <button class="chat-send-btn" onclick="sendSupportMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="modal-overlay" style="z-index: 100000;">
        <div class="modal-content" style="max-width: 350px; text-align: center;">
            <div style="margin-bottom: 15px;">
                <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
                <p id="custom-alert-message" style="font-size: 1rem; color: var(--text-main); margin: 0;">Mensagem aqui</p>
            </div>
            <button class="btn-primary" onclick="closeCustomAlert()" style="width: 100%;">OK</button>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="custom-confirm-modal" class="modal-overlay" style="z-index: 100001;">
        <div class="modal-content" style="max-width: 350px; text-align: center;">
            <div style="margin-bottom: 15px;">
                <i class="fas fa-question-circle" style="font-size: 3rem; color: var(--yellow); margin-bottom: 15px;"></i>
                <p id="custom-confirm-message" style="font-size: 1rem; color: var(--text-main); margin: 0;">Tem certeza?</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="closeCustomConfirm()" style="background: transparent; border: 1px solid var(--border); color: var(--text-muted);">Cancelar</button>
                <button id="btn-confirm-yes" class="btn-primary" style="background: var(--red);">Sim, confirmar</button>
            </div>
        </div>
    </div>

    <a id="btn-support-float" href="javascript:void(0)" class="btn-support" title="Falar com Suporte">
        <i class="fab fa-whatsapp"></i>
    </a>

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        let socket;
        let currentUser = {}; 
        let botsData = {}; 
        let groupsData = {}; 
        let viewedUser = null;
        let publicPrices = {};

        // Custom Alert Functions
        function showCustomAlert(msg) {
            document.getElementById('custom-alert-message').textContent = msg;
            document.getElementById('custom-alert-modal').style.display = 'flex';
        }

        function closeCustomAlert() {
            document.getElementById('custom-alert-modal').style.display = 'none';
        }

        // Custom Confirm Functions
        let pendingAction = null;

        function showCustomConfirm(msg, action) {
            document.getElementById('custom-confirm-message').textContent = msg;
            pendingAction = action;
            document.getElementById('custom-confirm-modal').style.display = 'flex';
        }

        function closeCustomConfirm() {
            document.getElementById('custom-confirm-modal').style.display = 'none';
            pendingAction = null;
        }

        document.getElementById('btn-confirm-yes').onclick = () => {
            if (pendingAction) pendingAction();
            closeCustomConfirm();
        };

        document.addEventListener('DOMContentLoaded', async () => {
            
            // Inicializa o socket imediatamente para receber atualizações de branding
            initializeSocket();

            // REMOÇÃO AGRESSIVA DE SERVICE WORKERS ANTIGOS
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }

            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.has('error')) {
                const errorMsg = urlParams.get('error');
                if(errorMsg && errorMsg.trim() !== "" && errorMsg.toLowerCase() !== 'bad request') {
                    showFeedback(false, errorMsg);
                }
                window.history.replaceState({}, document.title, "/");
            }

            try {
                // Adiciona timestamp para evitar cache do navegador
                const response = await fetch('/check-session?t=' + new Date().getTime());
                const data = await response.json();
                
                // Remove o loader inicial
                document.getElementById('app-loader').style.display = 'none';

                if (response.ok && data.loggedIn) {
                    enterDashboard(data.user);
                } else {
                    // Se a sessão não for válida, mostra a UI de login
                    const authSection = document.getElementById('auth-section');
                    authSection.classList.remove('hidden');
                    authSection.style.display = 'flex';
                    document.getElementById('dashboard-container').classList.add('hidden');
                }
            } catch (e) { 
                console.log("Sessão expirada ou não logado."); 
                document.getElementById('app-loader').style.display = 'none';
                const authSection = document.getElementById('auth-section');
                authSection.classList.remove('hidden');
                authSection.style.display = 'flex';
                document.getElementById('dashboard-container').classList.add('hidden');
            }

            function setupImagePreview(inputId, imgId) {
                const input = document.getElementById(inputId);
                const img = document.getElementById(imgId);
                
                if(input && img) {
                    const currentSrc = img.src;
                    if(currentSrc && !currentSrc.includes('data:')) {
                        img.src = currentSrc.split('?')[0] + '?v=' + new Date().getTime();
                    }

                    input.addEventListener('change', function(e) {
                        if (e.target.files && e.target.files[0]) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                img.src = e.target.result;
                            }
                            reader.readAsDataURL(e.target.files[0]);
                        }
                    });
                }
            }

            setupImagePreview('input-icon-small', 'preview-icon-small');
            setupImagePreview('input-icon-large', 'preview-icon-large');
        });

        function enterDashboard(user) {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard-container').classList.remove('hidden');
            document.getElementById('user-display-name').textContent = user.username;
            
            // O botão de menu agora aparece para todos
            document.getElementById('admin-menu-btn').classList.remove('hidden');
            
            // Se já recebemos os dados do usuário, atualizamos a visibilidade das áreas restritas
            if (currentUser && currentUser.isAdmin !== undefined) {
                updateAdminVisibility(currentUser.isAdmin);
            }
            
            // Se o socket já estiver conectado, solicitamos os dados do usuário
            if (socket && socket.connected) {
                socket.emit('get-my-bots');
                socket.emit('get-my-groups');
                if (user.isAdmin) {
                    socket.emit('admin-get-users');
                    socket.emit('admin-settings');
                }
            }
        }

        function updateAdminVisibility(isAdmin) {
            const adminContent = document.getElementById('admin-only-content');
            if (adminContent) {
                if (isAdmin) {
                    adminContent.classList.remove('hidden');
                } else {
                    adminContent.classList.add('hidden');
                }
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.style.display = 'none';
            } else {
                sidebar.classList.add('open');
                overlay.style.display = 'block';
            }
        }

        function navToDashboard() {
            document.getElementById('user-view').classList.remove('hidden');
            document.getElementById('admin-settings-view').classList.add('hidden');
            
            document.getElementById('btn-nav-dashboard').classList.add('active');
            document.getElementById('btn-nav-admin').classList.remove('active');
            
            toggleSidebar();
        }

        function navToAdminSettings() {
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-settings-view').classList.remove('hidden');
            
            document.getElementById('btn-nav-dashboard').classList.remove('active');
            document.getElementById('btn-nav-admin').classList.add('active');
            
            toggleSidebar();
        }

        function toggleAuthForms() {
            const login = document.getElementById('login-form-container');
            const register = document.getElementById('register-form-container');
            if(login.classList.contains('hidden')) {
                login.classList.remove('hidden'); register.classList.add('hidden');
            } else {
                login.classList.add('hidden'); register.classList.remove('hidden');
            }
        }

        async function handleAuth(url, body, btnId) {
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)});
                const data = await res.json();
                
                if (res.ok) {
                    if (url === '/login') {
                        window.location.reload();
                    } else { 
                        toggleAuthForms(); 
                        document.getElementById('login-username').value = body.username; 
                        showFeedback(true, 'Conta criada! Agora faça login.'); 
                    }
                } else {
                    showFeedback(false, data.message || 'Ocorreu um erro.');
                }
            } catch (error) { 
                showFeedback(false, 'Erro de conexão com o servidor.'); 
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        document.getElementById('login-form').onsubmit = (e) => { 
            e.preventDefault(); 
            handleAuth('/login', { 
                username: document.getElementById('login-username').value, 
                password: document.getElementById('login-password').value 
            }, 'btn-login-submit'); 
        };

        document.getElementById('register-form').onsubmit = (e) => {
            e.preventDefault();
            handleAuth('/register', {
                username: document.getElementById('reg-username').value,
                password: document.getElementById('reg-password').value
            }, 'btn-register-submit');
        };

        function showFeedback(success, msg) {
            const feedbackArea = document.getElementById('feedback-area');
            feedbackArea.textContent = msg;
            feedbackArea.className = success ? 'feedback-success' : 'feedback-error';
            feedbackArea.style.display = 'block';
            setTimeout(() => feedbackArea.style.display = 'none', 4000);
        }

        function fillExamplePrompt() {
            const example = "Você é o assistente virtual da Pizzaria. \n1. Seja educado.\n2. Cardápio: Pizza Queijo (R$30), Pizza Frango (R$35).";
            document.getElementById('prompt').value = example;
        }

        function confirmLogout() {
            showCustomConfirm('Tem certeza que deseja sair do painel?', () => {
                // Remove Service Workers para evitar cache agressivo
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(function(registrations) {
                        for(let registration of registrations) {
                            registration.unregister();
                        }
                    });
                }
                window.location.href = '/logout';
            });
        }

        function togglePlatformFields() {
            const platform = document.getElementById('botPlatform').value;
            const tokenGroup = document.getElementById('telegram-token-group');
            if (platform === 'telegram') {
                tokenGroup.classList.remove('hidden');
                tokenGroup.style.display = 'block';
            } else {
                tokenGroup.classList.add('hidden');
                tokenGroup.style.display = 'none';
            }
        }

        function openCreateModal() {
            document.getElementById('create-step-1').classList.remove('hidden');
            document.getElementById('create-step-2').classList.add('hidden');
            document.getElementById('create-bot-modal').style.display = 'flex';
        }

        function closeCreateModal() {
            document.getElementById('create-bot-modal').style.display = 'none';
        }

        function selectBotType(type) {
            document.getElementById('selectedBotType').value = type;
            
            const promptContainer = document.getElementById('prompt-container');
            const promptInput = document.getElementById('prompt');
            const sessionNameGroup = document.getElementById('sessionName-group');
            const sessionNameInput = document.getElementById('sessionName');
            
            if (type === 'group') {
                promptContainer.classList.add('hidden');
                promptInput.required = false;
                sessionNameGroup.classList.remove('hidden');
                sessionNameInput.required = true;
            } else {
                promptContainer.classList.remove('hidden');
                promptInput.required = true;
                sessionNameGroup.classList.add('hidden');
                sessionNameInput.required = false;
            }

            document.getElementById('create-step-1').classList.add('hidden');
            document.getElementById('create-step-2').classList.remove('hidden');
            
            togglePlatformFields();
        }

        function backToBotTypeSelect() {
            document.getElementById('create-step-2').classList.add('hidden');
            document.getElementById('create-step-1').classList.remove('hidden');
        }

        function updateAppBranding(name) {
            if(!name) return;
            document.title = name;
            
            const appleTitle = document.querySelector('meta[name="apple-mobile-web-app-title"]');
            if(appleTitle) appleTitle.content = name;

            const brand = document.querySelector('.brand-center');
            if(brand) brand.innerHTML = `<i class="fas fa-robot"></i> ${name}`;
            
            const loginTitle = document.querySelector('#auth-section h2');
            if(loginTitle) loginTitle.innerText = name;
        }

        function initializeSocket() {
            if (socket && socket.connected) return;
            socket = io();

            socket.on('connect', () => {
                // Solicita preços e branding imediatamente ao conectar
                socket.emit('get-public-prices');
            });

            // Tratamento de erro de conexão (Autenticação falha)
            socket.on('connect_error', (err) => {
                if(err.message === 'Authentication error' || err.message === 'User not found in DB') {
                    // Se o servidor rejeitar a conexão por auth, força logout
                    window.location.href = '/logout';
                }
            });

            socket.on('session-info', (data) => {
                currentUser = data;
                updateUserLimitUI(data.botLimit || 1);
                updateAdminVisibility(data.isAdmin);

                socket.emit('get-my-bots');
                socket.emit('get-my-groups');
                
                // Se já recebemos os preços públicos, não precisamos pedir de novo, 
                // mas se for admin, pedimos as configs completas
                if (currentUser.isAdmin) {
                    socket.emit('admin-get-users');
                    socket.emit('admin-settings');
                }
            });

            socket.on('update-limit', (newLimit) => {
                currentUser.botLimit = newLimit;
                updateUserLimitUI(newLimit);
                document.getElementById('resell-modal').style.display = 'none';
                showFeedback(true, `Parabéns! Seu limite agora é de ${newLimit} robôs!`);
            });

            socket.on('initial-bots-list', (bots) => { 
                const grid = document.getElementById('bots-grid');
                
                // Remove o card temporário de carregamento se existir
                const tempCard = document.getElementById('temp-bot-loading');
                if(tempCard) tempCard.remove();

                grid.innerHTML = ''; 
                botsData = {}; 
                
                if (bots.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-robot"></i>
                            <h3>Nenhum robô encontrado</h3>
                            <p>Clique em "Novo Robô" para começar.</p>
                        </div>
                    `;
                } else {
                    bots.forEach(renderBotCard);
                    updateAllBotGroupCounts();
                }
                updateOnboardingSteps();
            });

            socket.on('initial-groups-list', (groups) => { 
                organizeGroups(groups);
                updateAllBotGroupCounts();
                updateOnboardingSteps();
            });
            
            socket.on('group-list-updated', (groups) => { 
                organizeGroups(groups);
                updateAllBotGroupCounts();
                updateOnboardingSteps();
            });

            socket.on('bot-updated', (bot) => { 
                if (!currentUser.isAdmin && bot.owner !== currentUser.username) return;
                if (currentUser.isAdmin && viewedUser && bot.owner !== viewedUser) return;
                
                if (currentUser.isAdmin && !viewedUser && bot.owner === currentUser.username) {
                } else if (currentUser.isAdmin && !viewedUser && bot.owner !== currentUser.username) {
                    return; 
                }

                // Remove o card temporário de carregamento se existir
                const tempCard = document.getElementById('temp-bot-loading');
                if(tempCard) tempCard.remove();

                const btn = document.getElementById('create-bot-btn');
                if(btn.disabled && document.getElementById(`bot-${bot.sessionName}`)) {
                    btn.disabled = false;
                    btn.innerHTML = 'Salvar e Criar Robô';
                }
                
                const emptyState = document.querySelector('.empty-state');
                if (emptyState) emptyState.remove();

                renderBotCard(bot); 
                renderGroupsForBot(bot.sessionName);
                updateOnboardingSteps();
            });
            socket.on('bot-deleted', (d) => { 
                const el = document.getElementById(`bot-${d.sessionName}`); 
                if(el) el.remove(); 
                
                const grid = document.getElementById('bots-grid');
                if (grid.children.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-robot"></i>
                            <h3>Nenhum robô encontrado</h3>
                            <p>Clique em "Novo Robô" para começar.</p>
                        </div>
                    `;
                }
                delete botsData[d.sessionName];
                updateOnboardingSteps();
            });
            socket.on('log-message', (d) => {
                const c = document.querySelector(`#bot-${d.sessionName} .logs-container`);
                if(c && !d.message.startsWith('QR_CODE:') && !d.message.startsWith('PAIRING_CODE:')) {
                    const l = document.createElement('div'); l.className='log-line'; l.textContent = `> ${d.message}`;
                    c.appendChild(l); c.scrollTop = c.scrollHeight;
                    localStorage.setItem(`log-${d.sessionName}`, c.innerHTML);
                }

                if (d.message && d.message.includes('Link de ativação detectado')) {
                    socket.emit('get-my-groups');
                    showFeedback(true, 'Novo grupo detectado! Atualizando lista...');
                }
            });
            socket.on('admin-users-list', (users) => {
                const list = document.getElementById('users-list'); list.innerHTML = '';
                users.forEach(u => {
                    const li = document.createElement('li'); li.className = 'user-list-item';
                    li.style.borderBottom = "1px solid #333"; li.style.padding = "10px 0"; li.style.display="flex"; li.style.justifyContent="space-between";
                    li.innerHTML = `
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:600; font-size:0.9rem;">${u.username}</span>
                            <span style="font-size:0.75rem; color:#888;">${u.isAdmin ? 'Administrador' : `Limite: ${u.botLimit || 1} bots`} | ID: ${u.username}</span>
                        </div>
                        ${!u.isAdmin ? `<i class="fas fa-trash" style="color:var(--red); cursor:pointer; padding:5px;" onclick="delUser(event, '${u.username}')"></i>` : ''}
                    `;
                    li.onclick = (e) => { if(e.target.tagName !== 'I') openAdminUserView(u); };
                    list.appendChild(li);
                });
            });
            
            socket.on('admin-settings', (s) => { 
                document.getElementById('admin-app-name').value = s.appName || 'zappbot';
                document.getElementById('mp-access-token').value = s.mpAccessToken || ''; 
                document.getElementById('admin-support-number').value = s.supportNumber || '';
            });

            socket.on('public-prices', (prices) => { 
                publicPrices = prices || {}; 

                updateAppBranding(prices.appName);

                const supportBtn = document.getElementById('btn-support-float');
                if (prices.supportNumber && prices.supportNumber.trim() !== "") {
                    const cleanNum = prices.supportNumber.replace(/\D/g, '');
                    supportBtn.href = `https://wa.me/${cleanNum}`;
                    supportBtn.style.display = 'flex';
                } else {
                    supportBtn.style.display = 'none';
                }

                if(document.getElementById('price-monthly')) {
                    document.getElementById('price-monthly').value = prices.priceMonthly || '';
                    document.getElementById('price-quarterly').value = prices.priceQuarterly || '';
                    document.getElementById('price-semiannual').value = prices.priceSemiannual || '';
                    document.getElementById('price-yearly').value = prices.priceYearly || '';
                    document.getElementById('price-resell-5').value = prices.priceResell5 || '';
                    document.getElementById('price-resell-10').value = prices.priceResell10 || '';
                    document.getElementById('price-resell-20').value = prices.priceResell20 || '';
                    document.getElementById('price-resell-30').value = prices.priceResell30 || '';
                }

                const payModal = document.getElementById('payment-modal');
                if(payModal && payModal.style.display !== 'none') {
                    const container = document.getElementById('plans-container');
                    if(container) {
                        container.innerHTML = '';
                        const plans = [
                            { id: 'monthly', title: 'Mensal', price: prices.priceMonthly, desc: '30 dias' },
                            { id: 'quarterly', title: 'Trimestral', price: prices.priceQuarterly, desc: '90 dias' },
                            { id: 'semiannual', title: 'Semestral', price: prices.priceSemiannual, desc: '180 dias' },
                            { id: 'yearly', title: 'Anual', price: prices.priceYearly, desc: '365 dias' }
                        ];
                        plans.forEach(p => {
                            const el = document.createElement('div'); el.className = 'plan-option';
                            el.innerHTML = `<div><div class="plan-title">${p.title}</div><div class="plan-desc">${p.desc}</div></div><div class="plan-price">R$ ${p.price}</div>`;
                            el.onclick = () => selectPlan(p.id);
                            container.appendChild(el);
                        });
                    }
                }

                const resellModal = document.getElementById('resell-modal');
                if(resellModal && resellModal.style.display !== 'none') {
                    const container = document.getElementById('resell-plans-container');
                    if(container) {
                        container.innerHTML = '';
                        const resellPlans = [
                            { id: 'resell_5', title: 'Pacote 5 Robôs', price: publicPrices.priceResell5, limit: 5 },
                            { id: 'resell_10', title: 'Pacote 10 Robôs', price: publicPrices.priceResell10, limit: 10 },
                            { id: 'resell_20', title: 'Pacote 20 Robôs', price: publicPrices.priceResell20, limit: 20 },
                            { id: 'resell_30', title: 'Pacote 30 Robôs', price: publicPrices.priceResell30, limit: 30 },
                        ];
                        resellPlans.forEach(p => {
                            const el = document.createElement('div'); el.className = 'plan-option';
                            el.innerHTML = `<div><div class="plan-title">${p.title} <span class="plan-badge-resell">Revenda</span></div><div class="plan-desc">Limite de ${p.limit} bots.</div></div><div class="plan-price">R$ ${p.price}</div>`;
                            el.onclick = () => selectResellPlan(p.id);
                            container.appendChild(el);
                        });
                    }
                }
            });

            socket.on('payment-success', (d) => { 
                if(document.getElementById('payment-modal').style.display !== 'none') {
                   if(document.getElementById('pay-session-name').innerText === d.sessionName) {
                       closePaymentModal(); showFeedback(true, 'Pagamento Recebido! Bot Renovado.');
                   }
                }
            });
            
            socket.on('group-activation-result', (data) => {
                if (data.success) {
                    const linkModal = document.getElementById('activation-link-modal');
                    if(linkModal) linkModal.style.display = 'none';

                    // Força atualização da lista de grupos
                    socket.emit('get-my-groups');

                    // VERIFICAÇÃO EM 3 ETAPAS PARA EVITAR FALSO POSITIVO
                    let attempts = 0;
                    const verifyInterval = setInterval(() => {
                        attempts++;
                        socket.emit('get-my-groups'); // Solicita novamente
                        
                        let found = false;
                        if (groupsData[data.botSessionName]) {
                            found = groupsData[data.botSessionName].find(g => g.groupId === data.groupId);
                        }

                        if (found) {
                            clearInterval(verifyInterval);
                            showFeedback(true, 'Grupo ativado e confirmado!');
                            openGroupEdit(data.groupId);
                        } else if (attempts >= 3) {
                            clearInterval(verifyInterval);
                            // Se após 3 tentativas não aparecer, avisa o usuário para atualizar
                            showFeedback(false, 'Grupo ativado, mas a lista não atualizou. Recarregue a página.');
                        }
                    }, 1500); // Tenta a cada 1.5 segundos
                } else {
                    showFeedback(false, data.message || 'Erro ao ativar grupo.');
                }
            });

            socket.on('feedback', (d) => {
                if(!d.success && d.error === 'limit_reached') {
                    openResellModal();
                    const btn = document.getElementById('create-bot-btn');
                    btn.disabled = false; btn.innerHTML = 'Salvar e Criar Robô';
                    
                    // Remove o card temporário se houver erro
                    const tempCard = document.getElementById('temp-bot-loading');
                    if(tempCard) tempCard.remove();

                } else {
                    showFeedback(d.success, d.message);
                    if (d.success && d.message.includes('ativado') || d.message.includes('pronto')) {
                        socket.emit('get-my-groups');
                    }
                    if (!d.success) {
                        const btn = document.getElementById('create-bot-btn');
                        btn.disabled = false; btn.innerHTML = 'Salvar e Criar Robô';
                        
                        // Remove o card temporário se houver erro
                        const tempCard = document.getElementById('temp-bot-loading');
                        if(tempCard) tempCard.remove();
                    } else {
                        closeCreateModal();
                        const btn = document.getElementById('create-bot-btn');
                        btn.disabled = false; btn.innerHTML = 'Salvar e Criar Robô';
                    }
                }
            });

            // --- SUPPORT CHAT LISTENERS ---
            socket.on('support-chat-response', (data) => {
                removeTypingIndicator();
                addChatMessage(data.text, 'bot', data.action);
            });
        }

        function organizeGroups(groupsList) {
            groupsData = {};
            groupsList.forEach(group => {
                if (!groupsData[group.managedByBot]) {
                    groupsData[group.managedByBot] = [];
                }
                groupsData[group.managedByBot].push(group);
            });
        }

        function updateAllBotGroupCounts() {
            Object.keys(botsData).forEach(sessionName => {
                renderGroupsForBot(sessionName);
            });
        }

        function updateUserLimitUI(limit) {
            const display = limit > 900 ? "Ilimitado" : limit;
            document.getElementById('current-limit-display').innerText = display;
            if(document.getElementById('current-limit-display-modal')) {
                document.getElementById('current-limit-display-modal').innerText = display;
            }
        }

        function openAdminUserView(user) {
            viewedUser = user.username;
            document.getElementById('admin-settings-view').classList.add('hidden');
            document.getElementById('user-view').classList.remove('hidden');
            
            const backBtn = document.getElementById('nav-back-btn');
            backBtn.classList.remove('hidden');
            
            document.getElementById('main-title-text').textContent = user.username;
            document.getElementById('sub-title-text').textContent = `Gerenciando bots deste usuário`;
            document.getElementById('user-logs-area').classList.remove('hidden');
            const logC = document.getElementById('user-log-content'); logC.innerHTML = '';
            if(user.log) user.log.slice().reverse().forEach(l => logC.innerHTML += `<div class="log-line">${l}</div>`);
            document.getElementById('bots-grid').innerHTML = '';
            socket.emit('admin-get-bots-for-user', { username: user.username });
        }

        function goBackToAdminHome() {
            viewedUser = null;
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-settings-view').classList.remove('hidden');
            document.getElementById('nav-back-btn').classList.add('hidden');
            document.getElementById('bots-grid').innerHTML = '';
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            if (isNaN(date)) return 'Data inválida';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        function renderBotCard(bot) {
            const prevBot = botsData[bot.sessionName];
            const prevStatus = prevBot ? prevBot.status : null;
            botsData[bot.sessionName] = bot;
            
            let card = document.getElementById(`bot-${bot.sessionName}`);
            
            let statusClass = 'st-offline'; let icon = 'fa-power-off'; let txt = "Desligado";
            let timeText = 'Aguardando Ativação';
            let pct = 0;
            let isExpired = false;
            let daysForInput = 0;

            const isGroupBot = bot.botType === 'group';
            const isTelegram = bot.platform === 'telegram';

            const now = new Date();
            const expireDate = new Date(bot.trialExpiresAt);
            isExpired = expireDate < now;

            if(bot.status === 'Online') { 
                statusClass='st-online'; icon='fa-check'; txt='Conectado'; 
            }
            else if(bot.status.includes('Iniciando')) { 
                statusClass='st-starting'; icon='fa-sync fa-spin'; txt='Iniciando...'; 
            }
            else if(bot.status.includes('Aguardando')) { 
                if (isTelegram) {
                    statusClass='st-starting'; icon='fa-sync fa-spin'; txt='Conectando...';
                } else {
                    statusClass='st-waiting'; icon='fa-qrcode'; txt='Ler QR Code'; 
                }
            }
            else if(isExpired && !isGroupBot) { 
                statusClass='st-expired'; icon='fa-times'; txt='Expirado'; 
            }
            else if(!bot.activated) { 
                if (isTelegram) {
                    statusClass = 'st-offline'; icon='fa-power-off'; txt='Desligado';
                } else {
                    statusClass = 'st-inactive'; icon='fa-hourglass-start'; txt='Aguardando QR'; 
                }
            }

            if (!isGroupBot) {
                const totalDuration = 31 * 24 * 60 * 60 * 1000;
                const timeLeft = expireDate - now;
                
                daysForInput = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                if (daysForInput < 0) daysForInput = 0;
                
                if (bot.isTrial && !isExpired) {
                    pct = 100; 
                    timeText = 'Teste Grátis Ativo';
                } else {
                    const daysLeft = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                    pct = Math.max(0, Math.min(100, (timeLeft/totalDuration)*100));
                    timeText = isExpired ? 'Plano Expirado' : `${daysLeft} dias restantes`;
                }
            }

            const adminTools = currentUser.isAdmin && !isGroupBot ? `
                <div class="admin-tools">
                    <span>DEFINIR DIAS RESTANTES:</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div class="counter-wrapper">
                            <button class="counter-btn" onclick="modDays('${bot.sessionName}', -1)"><i class="fas fa-minus"></i></button>
                            <input type="number" id="d-${bot.sessionName}" class="days-input" value="${daysForInput}">
                            <button class="counter-btn" onclick="modDays('${bot.sessionName}', 1)"><i class="fas fa-plus"></i></button>
                        </div>
                        <button class="btn-save-days" onclick="admSaveDays('${bot.sessionName}')" title="Salvar"><i class="fas fa-save"></i></button>
                    </div>
                </div>
            ` : '';

            let qrSection = '';
            if (bot.status === 'Aguardando QR Code' && !isTelegram) {
                if (bot.qr && bot.qr.startsWith('PAIRING_CODE:') && !isTelegram) {
                    const code = bot.qr.replace('PAIRING_CODE:', '');
                    qrSection = `
                        <div class="qr-area">
                            <div class="qr-instructions"><strong>Conectar com Código:</strong><ol><li>No WhatsApp > Aparelhos Conectados</li><li>Conectar um aparelho</li><li>Toque em "Conectar com número de telefone"</li></ol></div>
                            <div class="pairing-code-display">${code}</div>
                            <p style="font-size:0.8rem; color:#666;">Digite este código no seu celular.</p>
                        </div>
                    `;
                } else {
                    qrSection = `
                        <div class="qr-area">
                            <div class="qr-instructions"><strong>Conectar WhatsApp:</strong><ol><li>Abra o WhatsApp e vá em <strong>Aparelhos Conectados</strong>.</li><li>Toque em <strong>Conectar um aparelho</strong>.</li><li>Aponte a câmera para o QR Code abaixo.</li></ol></div>
                            <div class="qr-tgt" id="qr-tgt-${bot.sessionName}"></div>
                            <button class="btn-share-qr" onclick="shareQrCode('${bot.sessionName}')"><i class="fas fa-share-alt"></i> Compartilhar QR</button>
                            <button class="btn-use-code" onclick="openPairingModal('${bot.sessionName}')"><i class="fas fa-mobile-alt"></i> Conectar com Número</button>
                        </div>
                    `;
                }
            }

            let toggleBtnHtml = '';
            const isRunning = bot.status === 'Online' || bot.status.includes('Iniciando') || bot.status.includes('Aguardando');

            if (isRunning) {
                toggleBtnHtml = `<button class="icon-btn btn-act-stop" onclick="sock('stop-bot','${bot.sessionName}')"><i class="fas fa-stop"></i><span>Desligar</span></button>`;
            } else {
                toggleBtnHtml = `<button class="icon-btn btn-act-start" onclick="sock('start-bot','${bot.sessionName}')"><i class="fas fa-play"></i><span>Iniciar</span></button>`;
            }

            let groupButtonsHtml = '';
            let groupContainerHtml = '';
            
            if (isGroupBot) {
                // Botões integrados na action bar
                groupButtonsHtml = `
                    <button class="icon-btn btn-act-link" onclick="openGroupActivationModal('${bot.sessionName}')">
                        <i class="fas fa-link"></i><span>Ativar</span>
                    </button>
                    <button class="icon-btn btn-act-groups" onclick="toggleGroups('${bot.sessionName}')">
                        <i class="fas fa-layer-group"></i><span>Grupos<span class="badge-count" id="count-${bot.sessionName}">0</span></span>
                    </button>
                `;
                
                // Container da lista de grupos (fora da action bar)
                groupContainerHtml = `
                    <div id="groups-container-${bot.sessionName}" class="bot-groups-container">
                    </div>
                `;
            }

            const platformIcon = isTelegram ? '<i class="fab fa-telegram platform-icon-tg"></i>' : '<i class="fab fa-whatsapp platform-icon-wa"></i>';

            // Lógica para exibir o nome público se disponível
            let displayName = bot.sessionName;
            if (!isGroupBot) {
                if (bot.publicName) {
                    displayName = bot.publicName;
                } else if (bot.status === 'Online') {
                    displayName = "Conectado (Sem Nome)";
                } else {
                    displayName = "Aguardando Leitura...";
                }
            }

            const groupMsg = bot.status === 'Online' 
                ? "Este bot está conectado e pronto para gerenciar os grupos" 
                : "Este bot precisa ser conectado para poder gerenciar os grupos";

            const html = `
                <div class="card-header">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i class="fas ${isGroupBot ? 'fa-users' : 'fa-robot'}" style="color:var(--primary);"></i>
                        <span style="font-weight:600;" class="text-truncate" title="${displayName}">${displayName}</span>
                        ${platformIcon}
                        ${isGroupBot ? '<span class="bot-tag">MODO GRUPO</span>' : ''}
                    </div>
                    <div class="status-badge ${statusClass}"><i class="fas ${icon}"></i> ${txt}</div>
                </div>
                <div class="card-body">
                    ${!isGroupBot ? `
                    <div class="progress-container">
                        <div class="progress-info">
                            <span>Status</span><span style="color:${isExpired ? 'var(--red)' : 'var(--text-main)'}">${timeText}</span>
                        </div>
                        <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%; background:${isExpired ? 'var(--red)' : 'var(--primary)'}"></div></div>
                    </div>
                    <div style="border-top: 1px solid var(--border); margin-top: 10px; padding-top: 10px;">
                        <div class="date-info"><span>Criado em:</span><strong>${formatDate(bot.createdAt)}</strong></div>
                        <div class="date-info"><span>Vence em:</span><strong style="color: ${isExpired ? 'var(--red)' : 'var(--text-main)'}">${formatDate(bot.trialExpiresAt)}</strong></div>
                    </div>
                    ` : `<p class="help-text" style="text-align:center;">${groupMsg}</p>`}

                    ${qrSection}
                    <div class="logs-container">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#666;">
                            <span>TERMINAL</span> <span onclick="clearLogs('${bot.sessionName}')" style="cursor:pointer; font-size:0.65rem; text-decoration:underline;">Limpar</span>
                        </div>
                    </div>
                    
                    <!-- NOVA BARRA DE AÇÕES INTEGRADA -->
                    <div class="action-bar">
                        ${toggleBtnHtml}
                        ${groupButtonsHtml}
                        ${!isGroupBot ? `<button class="icon-btn" onclick="openEdit('${bot.sessionName}')"><i class="fas fa-pen"></i><span>Editar</span></button>` : ''}
                        ${!isGroupBot ? `<button class="icon-btn" onclick="openIgnoreModal('${bot.sessionName}')"><i class="fas fa-user-slash"></i><span>Ignorar</span></button>` : ''}
                        ${!isGroupBot ? `<button class="icon-btn btn-act-pay" onclick="openPay('${bot.sessionName}')"><i class="fas fa-bolt"></i><span>Renovar</span></button>` : ''}
                        <button class="icon-btn" onclick="delBot('${bot.sessionName}')"><i class="fas fa-trash"></i> <span>Excluir</span></button>
                    </div>
                    
                    ${groupContainerHtml}
                    ${adminTools}
                </div>
            `;

            if(!card) {
                card = document.createElement('div'); card.className = 'bot-card'; card.id = `bot-${bot.sessionName}`;
                document.getElementById('bots-grid').prepend(card);
            }
            card.innerHTML = html;

            if (bot.status === 'Offline') {
                localStorage.removeItem(`log-${bot.sessionName}`);
            }

            const svLogs = localStorage.getItem(`log-${bot.sessionName}`);
            const logC = card.querySelector('.logs-container');
            if(svLogs) { 
                const h = logC.firstElementChild.outerHTML; logC.innerHTML = h + svLogs.replace(/<div.*?TERMINAL.*?<\/div>/, ''); logC.scrollTop=logC.scrollHeight; 
            }
            if(bot.status === 'Aguardando QR Code' && bot.qr && !bot.qr.startsWith('PAIRING_CODE:') && !isTelegram) {
                const qt = card.querySelector(`#qr-tgt-${bot.sessionName}`); 
                if(qt) { 
                    qt.innerHTML=''; 
                    new QRCode(qt, {text:bot.qr, width:180, height:180}); 
                    if (prevStatus !== 'Aguardando QR Code') {
                        setTimeout(() => {
                            qt.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 500);
                    }
                }
            }
        }

        function toggleGroups(sessionName) {
            const container = document.getElementById(`groups-container-${sessionName}`);
            if (container) {
                container.classList.toggle('show');
            }
        }

        function renderGroupsForBot(sessionName) {
            const container = document.getElementById(`groups-container-${sessionName}`);
            const countSpan = document.getElementById(`count-${sessionName}`);
            
            if (!container) return;

            const groups = groupsData[sessionName] || [];
            if (countSpan) countSpan.innerText = groups.length;

            container.innerHTML = '';

            if (groups.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; font-size:0.75rem; padding:10px;">Nenhum grupo vinculado.</p>';
                return;
            }

            groups.forEach(group => {
                const now = new Date();
                const expiresAt = group.expiresAt ? new Date(group.expiresAt) : null;
                const isExpired = expiresAt && expiresAt < now;
                const isPaused = group.isPaused === true;
                
                let statusColor = isExpired ? 'var(--red)' : 'var(--green)';
                let statusText = isExpired ? 'Expirado' : 'Ativo';
                if (group.status === 'pending_payment') {
                    statusColor = 'var(--yellow)';
                    statusText = 'Pendente';
                }
                if (isPaused && !isExpired) {
                    statusColor = 'var(--text-muted)';
                    statusText = 'Pausado';
                }

                let actionButton = '';
                if (isExpired || group.status === 'pending_payment') {
                    actionButton = `<button class="icon-btn btn-act-pay" onclick="openPay(null, '${group.groupId}', '${group.groupName}')"><i class="fas fa-bolt"></i><span>Pagar</span></button>`;
                } else {
                    actionButton = `<button class="icon-btn" onclick="openPay(null, '${group.groupId}', '${group.groupName}')"><i class="fas fa-plus"></i><span>Estender</span></button>`;
                }

                const editButton = `<button class="icon-btn" onclick="openGroupEdit('${group.groupId}')"><i class="fas fa-pen"></i><span>Config</span></button>`;
                
                let toggleButton = '';
                if (!isExpired && group.status !== 'pending_payment') {
                    if (isPaused) {
                        toggleButton = `<button class="icon-btn btn-act-start" onclick="toggleGroupStatus('${group.groupId}', false)"><i class="fas fa-play"></i><span>Iniciar</span></button>`;
                    } else {
                        toggleButton = `<button class="icon-btn btn-act-stop" onclick="toggleGroupStatus('${group.groupId}', true)"><i class="fas fa-stop"></i><span>Parar</span></button>`;
                    }
                }

                let daysForInput = 0;
                if (expiresAt) {
                    const timeLeft = expiresAt - now;
                    daysForInput = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                    if (daysForInput < 0) daysForInput = 0;
                }

                const adminTools = currentUser.isAdmin ? `
                    <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #444; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.7rem; font-weight:bold; color:#666;">DEFINIR DIAS:</span>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <div class="counter-wrapper">
                                <button class="counter-btn" onclick="modGroupDays('${group.groupId}', -1)"><i class="fas fa-minus"></i></button>
                                <input type="number" id="gd-${group.groupId}" class="days-input" value="${daysForInput}">
                                <button class="counter-btn" onclick="modGroupDays('${group.groupId}', 1)"><i class="fas fa-plus"></i></button>
                            </div>
                            <button class="btn-save-days" onclick="admSaveGroupDays('${group.groupId}')" title="Salvar"><i class="fas fa-save"></i></button>
                        </div>
                    </div>
                ` : '';

                const html = `
                    <div class="nested-group-card" id="group-${group.groupId}">
                        <div class="nested-group-header">
                            <div class="nested-group-title text-truncate" title="${group.groupName}">
                                <i class="fas fa-users"></i> ${group.groupName}
                            </div>
                            <span style="font-size:0.7rem; color:${statusColor}; border:1px solid ${statusColor}; padding:2px 6px; border-radius:4px; font-weight:bold;">${statusText}</span>
                        </div>
                        
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; font-size:0.75rem; color:#888;">
                            <div>Criado: <strong style="color:#ccc;">${formatDate(group.createdAt)}</strong></div>
                            <div>Vence: <strong style="color:#fff;">${formatDate(group.expiresAt)}</strong></div>
                        </div>

                        <div class="action-bar">
                            ${toggleButton}
                            ${editButton}
                            ${actionButton}
                            <button class="icon-btn" onclick="deleteGroup('${group.groupId}', '${group.groupName}')"><i class="fas fa-trash"></i><span>Remover</span></button>
                        </div>
                        ${adminTools}
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function openGroupEdit(groupId) {
            let group = null;
            Object.values(groupsData).forEach(list => {
                const found = list.find(g => g.groupId === groupId);
                if (found) group = found;
            });

            if (!group) return;

            document.getElementById('edit-group-id-hidden').value = groupId;
            document.getElementById('edit-group-name-display').innerText = group.groupName;
            document.getElementById('edit-group-prompt').value = group.prompt || '';
            document.getElementById('edit-group-silence').value = group.silenceTime || 0;
            document.getElementById('edit-group-botname').value = group.botName || '';
            
            document.getElementById('group-edit-modal').style.display = 'flex';
        }

        document.getElementById('edit-group-form').onsubmit = (e) => {
            e.preventDefault();
            const groupId = document.getElementById('edit-group-id-hidden').value;
            const prompt = document.getElementById('edit-group-prompt').value;
            const silenceTime = document.getElementById('edit-group-silence').value;
            const botName = document.getElementById('edit-group-botname').value;

            socket.emit('update-group-settings', {
                groupId: groupId,
                settings: {
                    prompt: prompt,
                    silenceTime: parseInt(silenceTime),
                    botName: botName
                }
            });
            
            document.getElementById('group-edit-modal').style.display = 'none';
            showFeedback(true, 'Configurações do grupo salvas!');
        };

        function toggleGroupStatus(groupId, isPaused) {
            socket.emit('update-group-settings', {
                groupId: groupId,
                settings: { isPaused: isPaused }
            });
            const card = document.getElementById(`group-${groupId}`);
            if (card) card.style.opacity = '0.7';
        }

        function deleteGroup(groupId, groupName) {
            showCustomConfirm(`Tem certeza que deseja remover o grupo "${groupName}"?\n\nO bot deixará de responder neste grupo e as configurações serão perdidas.`, () => {
                socket.emit('delete-group', { groupId: groupId });
                const card = document.getElementById(`group-${groupId}`);
                if(card) card.style.opacity = '0.5';
            });
        }

        async function shareQrCode(sessionName) {
            const card = document.getElementById(`bot-${sessionName}`);
            const container = card.querySelector(`#qr-tgt-${sessionName}`);
            
            if (!container) {
                showFeedback(false, 'QR Code não encontrado.');
                return;
            }

            let sourceUrl = '';
            const canvasEl = container.querySelector('canvas');
            const imgEl = container.querySelector('img');

            if (canvasEl) {
                sourceUrl = canvasEl.toDataURL('image/png');
            } else if (imgEl && imgEl.src) {
                sourceUrl = imgEl.src;
            } else {
                showFeedback(false, 'Imagem QR CODE ainda não gerada.');
                return;
            }

            try {
                const tempImg = new Image();
                tempImg.onload = async () => {
                    const size = 300; 
                    const padding = 20; 
                    
                    const cvs = document.createElement('canvas');
                    cvs.width = size;
                    cvs.height = size;
                    const ctx = cvs.getContext('2d');

                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, size, size);

                    ctx.drawImage(tempImg, padding, padding, size - (padding * 2), size - (padding * 2));

                    cvs.toBlob(async (blob) => {
                        if (!blob) {
                            showFeedback(false, 'Erro ao gerar arquivo de imagem.');
                            return;
                        }

                        const file = new File([blob], `qrcode_${sessionName}.png`, { type: "image/png" });

                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                title: 'zappbot QR Code',
                                text: 'Escaneie este QR Code para conectar o bot ' + sessionName,
                                files: [file]
                            });
                        } else {
                            try {
                                const item = new ClipboardItem({ "image/png": blob });
                                await navigator.clipboard.write([item]);
                                showFeedback(true, 'Imagem copiada para a área de transferência!');
                            } catch (err) {
                                showFeedback(false, 'Seu navegador não suporta compartilhamento nativo.');
                            }
                        }
                    }, 'image/png');
                };
                
                tempImg.src = sourceUrl;

            } catch (err) {
                console.error(err);
                showFeedback(false, 'Erro ao compartilhar: ' + err.message);
            }
        }

        async function sharePixPayment(type) {
            const imgId = type === 'resell' ? 'resell-qrcode-display' : 'pix-qrcode-display';
            const textId = type === 'resell' ? 'resell-copy-paste' : 'pix-copy-paste';

            const img = document.getElementById(imgId);
            const textCode = document.getElementById(textId).value;

            if (!img.src || !textCode) {
                showFeedback(false, 'Informações de pagamento não encontradas.');
                return;
            }

            try {
                const blob = await (await fetch(img.src)).blob();
                const file = new File([blob], "pix_pagamento.png", { type: "image/png" });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: 'Pagamento Pix zappbot',
                        text: 'Aqui está o código Pix Copia e Cola:\n\n' + textCode,
                        files: [file]
                    });
                } else {
                    copyPixCode(textId);
                    showCustomAlert('Compartilhamento de arquivo não suportado neste navegador. O código Pix foi copiado para sua área de transferência!');
                }
            } catch (err) {
                console.error(err);
                copyPixCode(textId);
                showFeedback(true, 'Código copiado! (Compartilhamento falhou)');
            }
        }

        function openPairingModal(sessionName) {
            document.getElementById('pairing-sessionName-hidden').value = sessionName;
            document.getElementById('pairing-phone-number').value = '';
            document.getElementById('pairing-modal').style.display = 'flex';
        }

        document.getElementById('pairing-form').onsubmit = (e) => {
            e.preventDefault();
            const sessionName = document.getElementById('pairing-sessionName-hidden').value;
            let phoneNumber = document.getElementById('pairing-phone-number').value;
            
            phoneNumber = phoneNumber.replace(/\D/g, '');

            // Lógica para adicionar DDD 55 se o usuário esquecer (Brasil)
            // Telefones BR: 10 dígitos (Fixo: 11 + 8) ou 11 dígitos (Celular: 11 + 9)
            if (phoneNumber.length === 10 || phoneNumber.length === 11) {
                phoneNumber = '55' + phoneNumber;
            }

            if (phoneNumber.length < 10) {
                showFeedback(false, 'Número inválido. Digite com DDD.');
                return;
            }
            
            // Fecha o modal imediatamente
            document.getElementById('pairing-modal').style.display = 'none';

            // Adiciona feedback visual no card do bot
            const card = document.getElementById(`bot-${sessionName}`);
            if(card) {
                const body = card.querySelector('.card-body');
                // Remove área de QR existente se houver
                const existingQr = card.querySelector('.qr-area');
                if(existingQr) existingQr.remove();
                
                // Cria o loader
                const loader = document.createElement('div');
                loader.className = 'qr-area';
                loader.id = `loader-${sessionName}`;
                loader.innerHTML = `
                    <i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--primary); margin-bottom:10px;"></i>
                    <p>Gerando Código de Pareamento...</p>
                    <small style="color:var(--text-muted);">Isso pode levar alguns segundos.</small>
                `;
                
                // Insere antes dos logs
                const ref = card.querySelector('.logs-container');
                body.insertBefore(loader, ref);
            }
            
            socket.emit('stop-bot', { sessionName });
            
            setTimeout(() => {
                socket.emit('start-bot', { sessionName, phoneNumber });
                showFeedback(true, 'Solicitando código de pareamento...');
            }, 1000);
        };

        function sock(ev, name) { socket.emit(ev, { sessionName: name }); }
        function delBot(n) { showCustomConfirm('Apagar "'+n+'"?', () => sock('delete-bot', n)); }
        function modDays(sessionName, delta) { const input = document.getElementById(`d-${sessionName}`); let val = parseInt(input.value)||0; val+=delta; input.value=val; }
        function admSaveDays(sessionName) { socket.emit('admin-set-days', { sessionName: sessionName, days: document.getElementById(`d-${sessionName}`).value }); }
        
        function modGroupDays(groupId, delta) { 
            const input = document.getElementById(`gd-${groupId}`); 
            let val = parseInt(input.value)||0; 
            val+=delta; 
            input.value=val; 
        }
        function admSaveGroupDays(groupId) { 
            socket.emit('admin-set-group-days', { groupId: groupId, days: document.getElementById(`gd-${groupId}`).value }); 
        }

        function delUser(e, u) { e.stopPropagation(); showCustomConfirm('Apagar usuário '+u+'?', () => socket.emit('admin-delete-user', {username:u})); }
        function clearLogs(n) { localStorage.removeItem(`log-${n}`); document.querySelector(`#bot-${n} .logs-container`).innerHTML='<div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#666;"><span>TERMINAL</span><span onclick="clearLogs(\''+n+'\')" style="cursor:pointer; font-size:0.65rem; text-decoration:underline;">Limpar</span></div>'; }
        
        function openEdit(n) {
            const bot = botsData[n];
            document.getElementById('edit-modal').style.display='flex';
            document.getElementById('edit-sessionName-hidden').value=n;
            document.getElementById('edit-sessionName-display').value=n;
            document.getElementById('edit-prompt').value=bot.prompt;
            document.getElementById('edit-botTypeGroup').checked = bot.botType === 'group';
            
            document.getElementById('edit-silenceTime').value = bot.silenceTime || 0;
            document.getElementById('edit-notificationNumber').value = bot.notificationNumber || '';

            const silenceWrapper = document.getElementById('edit-silence-wrapper');
            const typeWrapper = document.getElementById('edit-type-wrapper');

            if (bot.botType === 'group') {
                document.getElementById('edit-global-settings').classList.add('hidden');
                document.getElementById('edit-group-mode-msg').classList.remove('hidden');
                typeWrapper.classList.remove('hidden');
            } else {
                document.getElementById('edit-global-settings').classList.remove('hidden');
                document.getElementById('edit-group-mode-msg').classList.add('hidden');
                typeWrapper.classList.add('hidden');
                silenceWrapper.classList.add('hidden');
            }
        }
        function closeEditModal() { document.getElementById('edit-modal').style.display='none'; }
        
        document.getElementById('edit-bot-form').onsubmit = (e) => { 
            e.preventDefault(); 
            socket.emit('update-bot', { 
                sessionName: document.getElementById('edit-sessionName-hidden').value, 
                newPrompt: document.getElementById('edit-prompt').value,
                botType: document.getElementById('edit-botTypeGroup').checked ? 'group' : 'individual',
                botName: '',
                silenceTime: document.getElementById('edit-silenceTime').value,
                notificationNumber: document.getElementById('edit-notificationNumber').value
            }); 
            closeEditModal(); 
        };

        function openIgnoreModal(sessionName) {
            const modal = document.getElementById('ignore-modal');
            document.getElementById('ignore-sessionName-hidden').value = sessionName;
            const bot = botsData[sessionName];
            renderIgnoredIdentifiers(bot.ignoredIdentifiers || []);
            document.getElementById('new-identifier-input').value = ''; 
            modal.style.display = 'flex';
        }

        function renderIgnoredIdentifiers(identifiers) {
            const container = document.getElementById('ignored-list-container');
            container.innerHTML = '';
            if (!identifiers || identifiers.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:var(--text-muted); font-size:0.8rem;">Nenhum nome na lista.</p>';
            } else {
                identifiers.forEach((item, index) => {
                    const el = document.createElement('div');
                    el.className = 'ignored-item';
                    el.innerHTML = `<span>${item.value}</span><i class="fas fa-times" onclick="removeIdentifier(${index})"></i>`;
                    container.appendChild(el);
                });
            }
        }
        
        document.getElementById('add-identifier-form').onsubmit = (e) => {
            e.preventDefault();
            const sessionName = document.getElementById('ignore-sessionName-hidden').value;
            const input = document.getElementById('new-identifier-input');
            const value = input.value.trim();
            if (!value) return;
            const currentList = botsData[sessionName].ignoredIdentifiers || [];
            const isDuplicate = currentList.some(item => item.value.toLowerCase() === value.toLowerCase());
            if (isDuplicate) { showFeedback(false, 'Este nome já está na lista.'); return; }
            const newList = [...currentList, { type: 'name', value: value }];
            updateIgnoredListOnServer(sessionName, newList);
            renderIgnoredIdentifiers(newList); 
            input.value = '';
        };

        function removeIdentifier(indexToRemove) {
            const sessionName = document.getElementById('ignore-sessionName-hidden').value;
            const currentList = botsData[sessionName].ignoredIdentifiers || [];
            const newList = currentList.filter((_, index) => index !== indexToRemove);
            updateIgnoredListOnServer(sessionName, newList);
            renderIgnoredIdentifiers(newList); 
        }

        function updateIgnoredListOnServer(sessionName, newList) {
            botsData[sessionName].ignoredIdentifiers = newList; 
            socket.emit('update-ignored-identifiers', { sessionName, ignoredIdentifiers: newList });
        }

        document.getElementById('add-bot-form').onsubmit=(e)=>{
            e.preventDefault(); 
            const nInput = document.getElementById('sessionName');
            const pInput = document.getElementById('prompt');
            const botType = document.getElementById('selectedBotType').value; 
            const platformInput = document.getElementById('botPlatform');
            const tokenInput = document.getElementById('telegramToken');

            let n = '';
            
            // Se for individual, gera um ID aleatório
            if (botType === 'individual') {
                n = 'bot_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            } else {
                n = nInput.value.trim().replace(/\s+/g,'_');
                if(n.length < 3) { showCustomAlert('O nome deve ter 3 letras.'); return; }
            }
            
            if (platformInput.value === 'telegram' && !tokenInput.value.trim()) {
                showCustomAlert('Para Telegram, o Token é obrigatório.');
                return;
            }

            const o = (currentUser.isAdmin && viewedUser) ? viewedUser : currentUser.username;
            const btn = document.getElementById('create-bot-btn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';
            
            // Fecha o modal imediatamente para evitar o "vácuo"
            closeCreateModal();

            // Adiciona um card temporário de carregamento na grid
            const grid = document.getElementById('bots-grid');
            const tempCard = document.createElement('div');
            tempCard.id = 'temp-bot-loading';
            tempCard.className = 'bot-card';
            tempCard.innerHTML = `
                <div class="card-body" style="align-items:center; justify-content:center; text-align:center; min-height:200px;">
                    <i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--primary); margin-bottom:15px;"></i>
                    <h4>Criando Robô...</h4>
                    <p style="color:var(--text-muted);">Aguarde, configurando ambiente.</p>
                </div>
            `;
            
            // Remove o empty state se existir
            const empty = document.querySelector('.empty-state');
            if(empty) empty.remove();

            grid.prepend(tempCard);

            socket.emit('create-bot', { 
                sessionName:n, 
                prompt: botType === 'group' ? '' : pInput.value.trim(), 
                owner:o,
                botType: botType,
                botName: '', 
                silenceTime: 0, 
                platform: platformInput.value,
                token: tokenInput.value.trim()
            });
            
            nInput.value=''; pInput.value=''; 
            tokenInput.value = '';
        };
        
        document.getElementById('admin-settings-form').onsubmit=(e)=>{ 
            e.preventDefault(); 
            socket.emit('save-settings', { 
                appName: document.getElementById('admin-app-name').value,
                mpAccessToken: document.getElementById('mp-access-token').value, 
                supportNumber: document.getElementById('admin-support-number').value,
                priceMonthly: document.getElementById('price-monthly').value,
                priceQuarterly: document.getElementById('price-quarterly').value,
                priceSemiannual: document.getElementById('price-semiannual').value,
                priceYearly: document.getElementById('price-yearly').value,
                priceResell5: document.getElementById('price-resell-5').value,
                priceResell10: document.getElementById('price-resell-10').value,
                priceResell20: document.getElementById('price-resell-20').value,
                priceResell30: document.getElementById('price-resell-30').value,
            }); 
            showFeedback(true, 'Configurações salvas!');
        };

        document.getElementById('upload-icons-form').onsubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('button');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            const formData = new FormData(form);

            try {
                const response = await fetch('/api/admin/upload-icons', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    showFeedback(true, result.message);
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showFeedback(false, result.message || 'Erro ao enviar ícones.');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                console.error(error);
                showFeedback(false, 'Erro de conexão.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        let currentPaySession = '';
        let currentPayGroup = '';
        function openPay(sessionName = null, groupId = null, groupName = null) {
            currentPaySession = sessionName;
            currentPayGroup = groupId;

            const m = document.getElementById('payment-modal'); 
            m.style.display='flex';
            
            if (groupId) {
                document.getElementById('payment-target-label').innerText = 'Grupo';
                document.getElementById('pay-session-name').innerText = groupName;
            } else {
                document.getElementById('payment-target-label').innerText = 'Robô';
                document.getElementById('pay-session-name').innerText = sessionName;
            }

            const container = document.getElementById('plans-container');
            container.innerHTML = '';
            const plans = [
                { id: 'monthly', title: 'Mensal', price: publicPrices.priceMonthly, desc: '30 dias' },
                { id: 'quarterly', title: 'Trimestral', price: publicPrices.priceQuarterly, desc: '90 dias' },
                { id: 'semiannual', title: 'Semestral', price: publicPrices.priceSemiannual, desc: '180 dias' },
                { id: 'yearly', title: 'Anual', price: publicPrices.priceYearly, desc: '365 dias' }
            ];
            plans.forEach(p => {
                const el = document.createElement('div'); el.className = 'plan-option';
                el.innerHTML = `<div><div class="plan-title">${p.title}</div><div class="plan-desc">${p.desc}</div></div><div class="plan-price">R$ ${p.price}</div>`;
                el.onclick = () => selectPlan(p.id);
                container.appendChild(el);
            });
            document.getElementById('pay-step-select').classList.remove('hidden');
            document.getElementById('pix-loading').classList.add('hidden');
            document.getElementById('pix-content').classList.add('hidden');
        }

        async function selectPlan(planType) {
            document.getElementById('pay-step-select').classList.add('hidden');
            document.getElementById('pix-loading').classList.remove('hidden');
            
            const payload = { planType: planType };
            if (currentPayGroup) {
                payload.groupId = currentPayGroup;
            } else {
                payload.sessionName = currentPaySession;
            }

            try {
                const res = await fetch('/api/create-payment', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
                const d = await res.json();
                if(res.ok) {
                    document.getElementById('pix-loading').classList.add('hidden');
                    document.getElementById('pix-content').classList.remove('hidden');
                    document.getElementById('pay-amount').innerText = `R$ ${d.amount}`;
                    document.getElementById('pix-qrcode-display').src = `data:image/png;base64,${d.qr_code_base64}`;
                    document.getElementById('pix-copy-paste').value = d.qr_code;
                } else { 
                    showCustomAlert(d.error || 'Erro ao gerar Pix'); 
                    closePaymentModal(); 
                }
            } catch { showCustomAlert('Erro de conexão'); closePaymentModal(); }
        }

        function openResellModal() {
            const m = document.getElementById('resell-modal');
            m.style.display = 'flex';
            const container = document.getElementById('resell-plans-container');
            container.innerHTML = '';
            const resellPlans = [
                { id: 'resell_5', title: 'Pacote 5 Robôs', price: publicPrices.priceResell5, limit: 5 },
                { id: 'resell_10', title: 'Pacote 10 Robôs', price: publicPrices.priceResell10, limit: 10 },
                { id: 'resell_20', title: 'Pacote 20 Robôs', price: publicPrices.priceResell20, limit: 20 },
                { id: 'resell_30', title: 'Pacote 30 Robôs', price: publicPrices.priceResell30, limit: 30 },
            ];
            resellPlans.forEach(p => {
                const el = document.createElement('div'); el.className = 'plan-option';
                el.innerHTML = `<div><div class="plan-title">${p.title} <span class="plan-badge-resell">Revenda</span></div><div class="plan-desc">Limite de ${p.limit} bots.</div></div><div class="plan-price">R$ ${p.price}</div>`;
                el.onclick = () => selectResellPlan(p.id);
                container.appendChild(el);
            });
            document.getElementById('resell-step-select').classList.remove('hidden');
            document.getElementById('resell-pix-loading').classList.add('hidden');
            document.getElementById('resell-pix-content').classList.add('hidden');
        }

        async function selectResellPlan(planId) {
            document.getElementById('resell-step-select').classList.add('hidden');
            document.getElementById('resell-pix-loading').classList.remove('hidden');
            try {
                const res = await fetch('/api/create-payment', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ planType: planId }) });
                const d = await res.json();
                if(res.ok) {
                    document.getElementById('resell-pix-loading').classList.add('hidden');
                    document.getElementById('resell-pix-content').classList.remove('hidden');
                    document.getElementById('resell-pay-amount').innerText = `R$ ${d.amount}`;
                    document.getElementById('resell-qrcode-display').src = `data:image/png;base64,${d.qr_code_base64}`;
                    document.getElementById('resell-copy-paste').value = d.qr_code;
                } else { showCustomAlert(d.error || 'Erro ao gerar Pix'); document.getElementById('resell-modal').style.display='none'; }
            } catch { showCustomAlert('Erro de conexão'); document.getElementById('resell-modal').style.display='none'; }
        }

        function resetPaymentModal() { 
            if (currentPayGroup) {
                const groupName = document.getElementById('pay-session-name').innerText;
                openPay(null, currentPayGroup, groupName);
            } else {
                openPay(currentPaySession);
            }
        }
        function copyPixCode(id) { const el=document.getElementById(id); el.select(); navigator.clipboard.writeText(el.value); showFeedback(true, 'Código Pix Copiado!'); }
        function closePaymentModal() { document.getElementById('payment-modal').style.display='none'; }
        window.onclick = (e) => { if(e.target.className === 'modal-overlay') e.target.style.display='none'; };

        async function openGroupActivationModal(sessionName) {
            const btn = document.querySelector(`#bot-${sessionName} .btn-act-link`);
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch('/api/generate-activation-link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ botSessionName: sessionName })
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('modal-bot-name').textContent = sessionName;
                    document.getElementById('activation-link-input').value = data.activationLink;
                    document.getElementById('activation-link-modal').style.display = 'flex';
                } else {
                    showFeedback(false, data.error || 'Não foi possível gerar o link.');
                }
            } catch (error) {
                showFeedback(false, 'Erro de conexão ao gerar o link.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        document.getElementById('copy-activation-link-btn').addEventListener('click', () => {
            const input = document.getElementById('activation-link-input');
            input.select();
            navigator.clipboard.writeText(input.value);
            showFeedback(true, 'Link Copiado!');
        });

        function downloadBackup() {
            window.location.href = '/api/admin/backup';
        }

        async function handleRestoreFile() {
            const input = document.getElementById('restore-file-input');
            if (input.files.length === 0) return;

            const file = input.files[0];
            const formData = new FormData();
            formData.append('backupFile', file);

            showCustomConfirm('ATENÇÃO: Restaurar um backup irá sobrescrever todos os usuários, bots e configurações atuais. Os bots serão reiniciados. Deseja continuar?', async () => {
                try {
                    showFeedback(true, 'Enviando backup e restaurando...');
                    const response = await fetch('/api/admin/restore', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();

                    if (response.ok) {
                        showFeedback(true, data.message);
                        setTimeout(() => window.location.reload(), 3000);
                    } else {
                        showFeedback(false, data.error || 'Erro ao restaurar backup.');
                    }
                } catch (error) {
                    showFeedback(false, 'Erro de conexão ao restaurar.');
                }
                input.value = '';
            });
        }

        // --- SUPPORT CHAT FUNCTIONS ---
        let chatTimer;
        const CHAT_INACTIVITY_TIMEOUT_MS = 5 * 60 * 1000; // 5 minutos de inatividade com chat aberto
        const CHAT_RETENTION_MS = 10 * 60 * 1000; // 10 minutos para limpar histórico se não reabrir

        function openSupportChat() {
            document.getElementById('support-chat-modal').style.display = 'flex';
            const input = document.getElementById('chat-input');
            
            // Tenta carregar histórico. Se tiver expirado, loadChatHistory limpará tudo.
            loadChatHistory();
            
            // Iniciar timer de inatividade
            resetChatTimer();
            
            setTimeout(() => input.focus(), 100);
        }

        function closeSupportChat(clearHistory = false) {
            document.getElementById('support-chat-modal').style.display = 'none';
            clearTimeout(chatTimer);
            
            if (clearHistory) {
                clearLocalChat();
            }
        }

        function clearLocalChat() {
            localStorage.removeItem('support_chat_history');
            document.getElementById('chat-messages').innerHTML = '';
            // Avisar o servidor para limpar o contexto
            if (socket) socket.emit('clear-support-history');
        }

        function handleChatKey(e) {
            resetChatTimer(); // Resetar timer ao digitar
            if (e.key === 'Enter') sendSupportMessage();
        }

        function sendSupportMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            addChatMessage(msg, 'user');
            showTypingIndicator(); // Mostra a animação de digitando
            socket.emit('support-chat-message', msg);
            input.value = '';
            
            resetChatTimer(); // Resetar timer ao enviar
        }

        function showTypingIndicator() {
            const container = document.getElementById('chat-messages');
            // Remove se já existir para evitar duplicatas
            removeTypingIndicator();
            
            const bubble = document.createElement('div');
            bubble.className = 'typing-indicator';
            bubble.id = 'typing-bubble';
            bubble.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const bubble = document.getElementById('typing-bubble');
            if (bubble) bubble.remove();
        }

        function addChatMessage(text, sender, action = null) {
            const container = document.getElementById('chat-messages');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender}`;
            
            // Converte quebras de linha em <br>
            bubble.innerHTML = text.replace(/\n/g, '<br>');

            if (action) {
                const btn = document.createElement('button');
                btn.className = 'action-chip';
                btn.innerHTML = getActionLabel(action);
                // CORREÇÃO: Usar setAttribute para persistir o evento no HTML string
                btn.setAttribute('onclick', `handleAction('${action}')`);
                bubble.appendChild(document.createElement('br'));
                bubble.appendChild(btn);
            }

            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
            
            // Salvar no localStorage com timestamp
            saveChatHistory();
            
            if (sender === 'bot') resetChatTimer(); // Resetar timer ao receber resposta
        }

        function saveChatHistory() {
            const container = document.getElementById('chat-messages');
            // Não salva o indicador de digitação no histórico
            const clone = container.cloneNode(true);
            const typing = clone.querySelector('#typing-bubble');
            if(typing) typing.remove();
            
            const data = {
                html: clone.innerHTML,
                timestamp: new Date().getTime()
            };
            
            localStorage.setItem('support_chat_history', JSON.stringify(data));
        }

        function loadChatHistory() {
            const rawData = localStorage.getItem('support_chat_history');
            const container = document.getElementById('chat-messages');
            
            if (rawData) {
                try {
                    const data = JSON.parse(rawData);
                    const now = new Date().getTime();
                    
                    // Se passou do tempo de retenção (10 min), limpa tudo
                    if (now - data.timestamp > CHAT_RETENTION_MS) {
                        clearLocalChat();
                        container.innerHTML = `
                            <div class="chat-bubble bot">
                                Olá! Sou o assistente virtual do ZappBot. Como posso te ajudar hoje?
                            </div>
                        `;
                    } else {
                        // Se não expirou, carrega o histórico
                        container.innerHTML = data.html;
                        container.scrollTop = container.scrollHeight;
                    }
                } catch (e) {
                    // Se der erro no JSON (formato antigo), limpa
                    clearLocalChat();
                }
            } else {
                container.innerHTML = `
                    <div class="chat-bubble bot">
                        Olá! Sou o assistente virtual do ZappBot. Como posso te ajudar hoje?
                    </div>
                `;
            }
        }

        function resetChatTimer() {
            clearTimeout(chatTimer);
            chatTimer = setTimeout(() => {
                closeSupportChat(true); // Fecha e limpa histórico por inatividade
            }, CHAT_INACTIVITY_TIMEOUT_MS);
        }

        function getActionLabel(action) {
            switch(action) {
                case 'OPEN_CREATE': return 'Criar Novo Robô';
                case 'OPEN_RESELL': return 'Aumentar Limite';
                case 'OPEN_BACKUP': return 'Ir para Backup';
                case 'OPEN_CLIENTS': return 'Gerenciar Clientes';
                default: return 'Abrir';
            }
        }

        function handleAction(action) {
            // Não fecha o chat completamente, apenas esconde se necessário, 
            // mas a ação pode exigir navegação.
            // Se navegar, o chat reseta naturalmente.
            closeSupportChat(); 
            switch(action) {
                case 'OPEN_CREATE': openCreateModal(); break;
                case 'OPEN_RESELL': openResellModal(); break;
                case 'OPEN_BACKUP': navToAdminSettings(); break;
                case 'OPEN_CLIENTS': window.location.href='/clients.html'; break;
            }
        }

        // --- ONBOARDING GUIDE SYSTEM ---
        function updateOnboardingSteps() {
            // Remove highlights anteriores
            document.querySelectorAll('.guide-highlight').forEach(el => el.classList.remove('guide-highlight'));

            const botKeys = Object.keys(botsData);
            
            // Passo 1: Nenhum bot criado
            if (botKeys.length === 0) {
                const btnNew = document.getElementById('btn-new-bot');
                if (btnNew) btnNew.classList.add('guide-highlight');
                return;
            }

            // Passo 2: Bot criado, mas não conectado (Aguardando QR ou Inativo)
            for (const key of botKeys) {
                const bot = botsData[key];
                if (bot.status !== 'Online' && !bot.status.includes('Iniciando')) {
                    // Tenta achar o botão de iniciar ou QR code
                    const card = document.getElementById(`bot-${key}`);
                    if (card) {
                        // Se estiver aguardando QR, destaca a área do QR ou botão de conectar
                        if (bot.status.includes('Aguardando')) {
                            const btnUseCode = card.querySelector('.btn-use-code');
                            if (btnUseCode) {
                                btnUseCode.classList.add('guide-highlight');
                                return;
                            }
                        }
                        // Se estiver desligado, destaca o botão de iniciar
                        const btnStart = card.querySelector('.btn-act-start');
                        if (btnStart) {
                            btnStart.classList.add('guide-highlight');
                            return;
                        }
                    }
                }
            }

            // Passo 3: Bot de Grupo Online, mas sem grupos
            for (const key of botKeys) {
                const bot = botsData[key];
                if (bot.botType === 'group' && bot.status === 'Online') {
                    const groups = groupsData[key] || [];
                    if (groups.length === 0) {
                        const card = document.getElementById(`bot-${key}`);
                        if (card) {
                            const btnLink = card.querySelector('.btn-act-link');
                            if (btnLink) {
                                btnLink.classList.add('guide-highlight');
                                return;
                            }
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>

